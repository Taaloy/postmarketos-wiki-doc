<!DOCTYPE html>
<html class="client-nojs" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>Category:Bootloaders/Bootloaders porting using linux - postmarketOS</title>
<link rel="stylesheet" href="../PostmarketOSWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.39.5">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.25, maximum-scale=5.0">
<link rel="icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="postmarketOS (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.postmarketos.org/api.php?action=rsd">
<link rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">
<link rel="alternate" type="application/atom+xml" title="postmarketOS Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="skin-vector skin-vector-search-vue mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-14 ns-subject page-Category_Bootloaders_Bootloaders_porting_using_linux rootpage-Category_Bootloaders_Bootloaders_porting_using_linux skin-vector-2022 action-view skin--responsive skin-vector-disable-max-width vector-feature-language-in-header-enabled vector-feature-language-in-main-page-header-disabled vector-feature-language-alert-in-sidebar-disabled vector-feature-sticky-header-disabled vector-feature-sticky-header-edit-disabled vector-feature-table-of-contents-disabled vector-feature-visual-enhancement-next-disabled">
<div class="mw-page-container">
	<span id="top-page"></span>
	<a class="mw-jump-link" href="#content">Jump to content</a>
	<div class="mw-page-container-inner">
		<input type="checkbox" id="mw-sidebar-checkbox" class="mw-checkbox-hack-checkbox">
		<header class="mw-header">
			<div class="mw-header-aside">
			<label id="mw-sidebar-button" class="mw-checkbox-hack-button mw-ui-icon mw-ui-button mw-ui-quiet mw-ui-icon-element" for="mw-sidebar-checkbox" role="button" aria-controls="mw-panel" data-event-name="ui.sidebar" tabindex="0" title="Main menu">
				<span>Toggle sidebar</span>
			</label>
			
<a href="../en/Main_Page.html" class="mw-logo">
	<img class="mw-logo-icon" src="/logo_50x50.svg" alt="" aria-hidden="true" height="50" width="50">
	<span class="mw-logo-container">
		<strong class="mw-logo-wordmark">postmarketOS</strong>
	</span>
</a>

			</div>
			<div class="mw-header-content">
			
<div id="p-search" role="search" class="vector-search-box-vue  vector-search-box-collapses  vector-search-box-show-thumbnail vector-search-box-auto-expand-width vector-search-box">
	<a href="../Special:Search.html" title="Search postmarketOS [f]" accesskey="f" class="mw-ui-button mw-ui-quiet mw-ui-icon mw-ui-icon-element mw-ui-icon-wikimedia-search search-toggle">
		<span>Search</span>
	</a>
	
	<div>
		<form action="/index.php" id="searchform" class="vector-search-box-form">
			<div id="simpleSearch" class="vector-search-box-inner" data-search-loc="header-moved">
				<input class="vector-search-box-input" type="search" name="search" placeholder="Search postmarketOS" aria-label="Search postmarketOS" autocapitalize="sentences" title="Search postmarketOS [f]" accesskey="f" id="searchInput">
				<input type="hidden" name="title" value="Special:Search">
				<input id="mw-searchButton" class="searchButton mw-fallbackSearchButton" type="submit" name="fulltext" title="Search the pages for this text" value="Search">
				<input id="searchButton" class="searchButton" type="submit" name="go" title="Go to a page with this exact name if it exists" value="Go">
			</div>
		</form>
	</div>
</div>

			<nav class="vector-user-links" aria-label="Personal tools" role="navigation">
	

<div id="p-vector-user-menu-overflow" class="vector-menu mw-portlet mw-portlet-vector-user-menu-overflow vector-user-menu-overflow">
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"><li id="pt-createaccount-2" class="user-links-collapsible-item mw-list-item"><a href="../Special:RequestAccount.html"><span>Request account</span></a></li></ul>
		
	</div>
</div>

	

<div id="p-personal" class="vector-menu mw-portlet mw-portlet-personal vector-user-menu vector-user-menu-logged-out vector-menu-dropdown" title="More options">
	<input type="checkbox" id="p-personal-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-p-personal" class="vector-menu-checkbox">
	<label id="p-personal-label" for="p-personal-checkbox" class="vector-menu-heading mw-ui-button mw-ui-quiet mw-ui-icon mw-ui-icon-element mw-ui-icon-ellipsis mw-ui-icon-wikimedia-ellipsis">
		<span class="vector-menu-heading-label">Personal tools</span>
	</label>
	<div class="vector-menu-content">
		<div class="vector-user-menu-create-account"><a href="/index.php?title=Special:CreateAccount&amp;returnto=Category%3ABootloaders%2FBootloaders+porting+using+linux" class="vector-menu-content-item user-links-collapsible-item" title="You are encouraged to create an account and log in; however, it is not mandatory"><span class="mw-ui-icon mw-ui-icon-userAdd mw-ui-icon-wikimedia-userAdd"></span> <span>Create account</span></a></div>
<div class="vector-user-menu-login"><a href="/index.php?title=Special:UserLogin&amp;returnto=Category%3ABootloaders%2FBootloaders+porting+using+linux" class="vector-menu-content-item vector-menu-content-item-login" title="You are encouraged to log in; however, it is not mandatory [o]" accesskey="o"><span class="mw-ui-icon mw-ui-icon-logIn mw-ui-icon-wikimedia-logIn"></span> <span>Log in</span></a></div>

		<ul class="vector-menu-content-list"></ul>
		
	</div>
</div>

</nav>

			</div>
		</header>
		<div class="vector-sidebar-container ">
			</div>
		<div class="vector-sitenotice-container">
			<div id="siteNotice"></div>
		</div>
		<input type="checkbox" id="vector-toc-collapsed-checkbox" class="mw-checkbox-hack-checkbox">
		<div class="mw-table-of-contents-container">
			<div class="vector-sticky-toc-container mw-sticky-header-element">
				<nav id="mw-panel-toc" class="sidebar-toc" role="navigation" aria-labelledby="sidebar-toc-label" data-event-name="ui.sidebar-toc">
	<div id="sidebar-toc-label" class="sidebar-toc-header">
		<p class="sidebar-toc-title">
		Contents
		<button class="vector-toc-uncollapse-button">move to sidebar</button>
		<button class="vector-toc-collapse-button">hide</button>
		</p>
	</div>
	<ul class="sidebar-toc-contents" id="mw-panel-toc-list">
		<li id="toc-mw-content-text" class="sidebar-toc-list-item sidebar-toc-level-1">
			<a href="#top-page" class="sidebar-toc-link">
				<div class="sidebar-toc-text">Beginning</div>
			</a>
		</li>
		<li id="toc-About" class="sidebar-toc-list-item sidebar-toc-level-1 sidebar-toc-list-item-expanded">
			<a class="sidebar-toc-link" href="#About">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">1</span>About</div>
			</a>
			
			<ul id="toc-About-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-Getting_started" class="sidebar-toc-list-item sidebar-toc-level-1 sidebar-toc-list-item-expanded">
			<a class="sidebar-toc-link" href="#Getting_started">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">2</span>Getting started</div>
			</a>
			
			<ul id="toc-Getting_started-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-Getting_uart_debug_output_from_linux" class="sidebar-toc-list-item sidebar-toc-level-1 sidebar-toc-list-item-expanded">
			<a class="sidebar-toc-link" href="#Getting_uart_debug_output_from_linux">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">3</span>Getting uart debug output from linux</div>
			</a>
			
				<button aria-controls="toc-Getting_uart_debug_output_from_linux-sublist" class="mw-ui-icon mw-ui-icon-wikimedia-expand mw-ui-icon-small sidebar-toc-toggle">
					Toggle Getting uart debug output from linux subsection
				</button>
			
			<ul id="toc-Getting_uart_debug_output_from_linux-sublist" class="sidebar-toc-list">
				<li id="toc-Hack_MUIC_driver_to_expose_uart_on_request" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#Hack_MUIC_driver_to_expose_uart_on_request">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">3.1</span>Hack MUIC driver to expose uart on request</div>
			</a>
			
			<ul id="toc-Hack_MUIC_driver_to_expose_uart_on_request-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-Setup_pmos_to_switch_muic_on_key_combination" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#Setup_pmos_to_switch_muic_on_key_combination">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">3.2</span>Setup pmos to switch muic on key combination</div>
			</a>
			
			<ul id="toc-Setup_pmos_to_switch_muic_on_key_combination-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-Build_a_cable" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#Build_a_cable">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">3.3</span>Build a cable</div>
			</a>
			
			<ul id="toc-Build_a_cable-sublist" class="sidebar-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Hack_kernel_to_execute_your_bootloader" class="sidebar-toc-list-item sidebar-toc-level-1 sidebar-toc-list-item-expanded">
			<a class="sidebar-toc-link" href="#Hack_kernel_to_execute_your_bootloader">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">4</span>Hack kernel to execute your bootloader</div>
			</a>
			
			<ul id="toc-Hack_kernel_to_execute_your_bootloader-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-Run_bootloader_builds" class="sidebar-toc-list-item sidebar-toc-level-1 sidebar-toc-list-item-expanded">
			<a class="sidebar-toc-link" href="#Run_bootloader_builds">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">5</span>Run bootloader builds</div>
			</a>
			
			<ul id="toc-Run_bootloader_builds-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-Troubleshooting" class="sidebar-toc-list-item sidebar-toc-level-1 sidebar-toc-list-item-expanded">
			<a class="sidebar-toc-link" href="#Troubleshooting">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">6</span>Troubleshooting</div>
			</a>
			
				<button aria-controls="toc-Troubleshooting-sublist" class="mw-ui-icon mw-ui-icon-wikimedia-expand mw-ui-icon-small sidebar-toc-toggle">
					Toggle Troubleshooting subsection
				</button>
			
			<ul id="toc-Troubleshooting-sublist" class="sidebar-toc-list">
				<li id="toc-No_output_from_your_uart" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#No_output_from_your_uart">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">6.1</span>No output from your uart</div>
			</a>
			
			<ul id="toc-No_output_from_your_uart-sublist" class="sidebar-toc-list">
				<li id="toc-DMA_uart_mode." class="sidebar-toc-list-item sidebar-toc-level-3">
			<a class="sidebar-toc-link" href="#DMA_uart_mode.">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">6.1.1</span>DMA uart mode.</div>
			</a>
			
			<ul id="toc-DMA_uart_mode.-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-Uart_is_reset_by_bootloader." class="sidebar-toc-list-item sidebar-toc-level-3">
			<a class="sidebar-toc-link" href="#Uart_is_reset_by_bootloader.">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">6.1.2</span>Uart is reset by bootloader.</div>
			</a>
			
			<ul id="toc-Uart_is_reset_by_bootloader.-sublist" class="sidebar-toc-list">
			</ul>
		</li>
	</ul>
		</li>
		<li id="toc-Phone_reboots_after_executing_bootloader" class="sidebar-toc-list-item sidebar-toc-level-2">
			<a class="sidebar-toc-link" href="#Phone_reboots_after_executing_bootloader">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">6.2</span>Phone reboots after executing bootloader</div>
			</a>
			
			<ul id="toc-Phone_reboots_after_executing_bootloader-sublist" class="sidebar-toc-list">
			</ul>
		</li>
	</ul>
		</li>
	</ul>
</nav>

			</div>
		</div>
		<div class="mw-content-container">
			<main id="content" class="mw-body" role="main" style="margin: 0">
				<a id="top"></a>
				<header class="mw-body-header">
				
				
					<label id="vector-toc-collapsed-button" class="mw-ui-button mw-ui-quiet mw-ui-icon mw-ui-icon-element mw-ui-icon-wikimedia-listBullet mw-checkbox-hack-button" for="vector-toc-collapsed-checkbox" role="button" aria-controls="toc-toggle-list" data-event-name="vector.toc-toggle-list" tabindex="0" title="Table of Contents">
						Toggle the table of contents
					</label>
				    <h1 id="firstHeading" class="firstHeading mw-first-heading">
<span class="mw-page-title-namespace">Category</span><span class="mw-page-title-separator">:</span><span class="mw-page-title-main">Bootloaders/Bootloaders porting using linux</span>
</h1>
				</header>
				<nav class="vector-article-toolbar" aria-label="Tools" role="navigation">
					<div class="mw-article-toolbar-container">
						<div id="left-navigation">
							

<div id="p-associated-pages" class="vector-menu mw-portlet mw-portlet-associated-pages vector-menu-tabs">
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list">
<li id="ca-nstab-category" class="selected mw-list-item"><a href="../en/Category:Bootloaders_Bootloaders_porting_using_linux.html" title="View the category page [c]" accesskey="c"><span>Category</span></a></li>
<li id="ca-talk" class="new mw-list-item"><a href="/index.php?title=Category_talk:Bootloaders/Bootloaders_porting_using_linux&amp;action=edit&amp;redlink=1" rel="discussion" title="Discussion about the content page (page does not exist) [t]" accesskey="t"><span>Discussion</span></a></li>
</ul>
		
	</div>
</div>

							

<div id="p-variants" class="vector-menu mw-portlet mw-portlet-variants emptyPortlet vector-menu-dropdown">
	<input type="checkbox" id="p-variants-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-p-variants" class="vector-menu-checkbox" aria-label="Change language variant">
	<label id="p-variants-label" for="p-variants-checkbox" class="vector-menu-heading ">
		<span class="vector-menu-heading-label">English</span>
	</label>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"></ul>
		
	</div>
</div>

						</div>
						<div id="right-navigation" class="vector-collapsible ">
							

<div id="p-views" class="vector-menu mw-portlet mw-portlet-views vector-menu-tabs">
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list">
<li id="ca-view" class="selected mw-list-item"><a href="../en/Category:Bootloaders_Bootloaders_porting_using_linux.html"><span>Read</span></a></li>
<li id="ca-viewsource" class="mw-list-item"><a href="/index.php?title=Category:Bootloaders/Bootloaders_porting_using_linux&amp;action=edit" title="This page is protected.
You can view its source [e]" accesskey="e"><span>View source</span></a></li>
<li id="ca-history" class="mw-list-item"><a href="/index.php?title=Category:Bootloaders/Bootloaders_porting_using_linux&amp;action=history" title="Past revisions of this page [h]" accesskey="h"><span>View history</span></a></li>
</ul>
		
	</div>
</div>

							

<div id="p-cactions" class="vector-menu mw-portlet mw-portlet-cactions emptyPortlet vector-menu-dropdown vector-has-collapsible-items" title="More options">
	<input type="checkbox" id="p-cactions-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-p-cactions" class="vector-menu-checkbox">
	<label id="p-cactions-label" for="p-cactions-checkbox" class="vector-menu-heading ">
		<span class="vector-menu-heading-label">More</span>
	</label>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list">
<li id="ca-more-view" class="selected vector-more-collapsible-item mw-list-item"><a href="../en/Category:Bootloaders_Bootloaders_porting_using_linux.html"><span>Read</span></a></li>
<li id="ca-more-viewsource" class="vector-more-collapsible-item mw-list-item"><a href="/index.php?title=Category:Bootloaders/Bootloaders_porting_using_linux&amp;action=edit"><span>View source</span></a></li>
<li id="ca-more-history" class="vector-more-collapsible-item mw-list-item"><a href="/index.php?title=Category:Bootloaders/Bootloaders_porting_using_linux&amp;action=history"><span>View history</span></a></li>
</ul>
		
	</div>
</div>

						</div>
					</div>
				</nav>
				<div id="bodyContent" class="vector-body" data-mw-ve-target-container>
					<div class="mw-body-subheader">
					        <div class="mw-indicators">
        <div id="mw-indicator-mw-helplink" class="mw-indicator"><a href="https://www.mediawiki.org/wiki/Special:MyLanguage/Help:Categories" target="_blank" class="mw-helplink">Help</a></div>
        </div>

					    <div id="siteSub" class="noprint">From postmarketOS</div>
					</div>
					
					
					
					<div id="mw-content-text" class="mw-body-content mw-content-ltr" lang="en" dir="ltr">
<div class="mw-parser-output">
<p><br>
</p>
<tocplace></tocplace>
<h2><span class="mw-headline" id="About">About</span></h2>
<p>This article describes how to get debug uart, when you don't have vendor's debug uart cable and don't want to disassemble your phone, and how to execute a payload (i.e. you bootloader port). 
</p>
<p>You must have debug uart, if you want to port bootloader on your phone. However, some bootloaders and/or MUIC chips does not allow you to connect to debug uart (like recent Samsung phones with usb type-c). In this case, you can either:  
</p>
<ul>
<li>disassemble the phone, find and connect to debug uart pins, exposed on the board.</li>
<li>Hack linux to force expose debug uart, and then test your bootloader.</li>
</ul>
<p>We'll speak about the latter.  
</p>
<p>This method is quite similar to kexec, though differs in some details:
</p>
<ul>
<li>MMU should be turned off completely</li>
<li>Use bin format, to simplify load process.</li>
</ul>
<h2><span class="mw-headline" id="Getting_started">Getting started</span></h2>
<p>You'll need: 
</p>
<ul>
<li>PmOs downstream port (TWRP can be used)</li>
<li><a href="../en/Serial_debugging.html#Building_the_cable" title="Serial debugging">Stuff for building debug cable</a></li>
</ul>
<h2><span class="mw-headline" id="Getting_uart_debug_output_from_linux">Getting uart debug output from linux</span></h2>
<h3><span class="mw-headline" id="Hack_MUIC_driver_to_expose_uart_on_request">Hack MUIC driver to expose uart on request</span></h3>
<p>We can use sysfs attribute to tell muic driver, we need to switch debug uart to usb. 
For example, MUIC driver patch for <a href="../en/Samsung_Galaxy_S9_(samsung-starqltechn).html" title="Samsung Galaxy S9 (samsung-starqltechn)">Samsung Galaxy S9</a>
</p>
<div class="mw-highlight mw-highlight-lang-diff mw-content-ltr" dir="ltr"><pre><span></span><span class="gh">diff --git a/drivers/muic/max77705-muic.c b/drivers/muic/max77705-muic.c</span><span class="w"></span>
<span class="gh">index c424c03f9..156152daf 100644</span><span class="w"></span>
<span class="gd">--- a/drivers/muic/max77705-muic.c</span><span class="w"></span>
<span class="gi">+++ b/drivers/muic/max77705-muic.c</span><span class="w"></span>
<span class="gu">@@ -5,6 +5,7 @@</span><span class="w"></span>
<span class="w"> </span> * it under the terms of the GNU General Public License version 2 as<span class="w"></span>
<span class="w"> </span> * published by the Free Software Foundation.<span class="w"></span>
<span class="w"> </span> */<span class="w"></span>
<span class="gi">+#define MANUAL_UART_SWITCH</span><span class="w"></span>
<span class="w"> </span>
<span class="w"> </span>#include &lt;linux/kernel.h&gt;<span class="w"></span>
<span class="w"> </span>#include &lt;linux/module.h&gt;<span class="w"></span>
<span class="gu">@@ -1005,8 +1006,81 @@ static ssize_t hiccup_store(struct device *dev,</span><span class="w"></span>
<span class="w"> </span>}<span class="w"></span>
<span class="w"> </span>#endif /* CONFIG_HICCUP_CHARGER */<span class="w"></span>
<span class="w"> </span>
<span class="gi">+void max77705_muic_read_register(struct i2c_client *i2c)</span><span class="w"></span>
<span class="gi">+{</span><span class="w"></span>
<span class="gi">+	const enum max77705_usbc_reg regfile[] = {</span><span class="w"></span>
<span class="gi">+		MAX77705_USBC_REG_UIC_HW_REV,</span><span class="w"></span>
<span class="gi">+		MAX77705_USBC_REG_USBC_STATUS1,</span><span class="w"></span>
<span class="gi">+		MAX77705_USBC_REG_USBC_STATUS2,</span><span class="w"></span>
<span class="gi">+		MAX77705_USBC_REG_BC_STATUS,</span><span class="w"></span>
<span class="gi">+		MAX77705_USBC_REG_UIC_INT_M,</span><span class="w"></span>
<span class="gi">+	};</span><span class="w"></span>
<span class="gi">+	u8 val;</span><span class="w"></span>
<span class="gi">+	int i, ret;</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+	pr_info("%s read register--------------\n", __func__);</span><span class="w"></span>
<span class="gi">+	for (i = 0; i &lt; (int)ARRAY_SIZE(regfile); i++) {</span><span class="w"></span>
<span class="gi">+		ret = max77705_muic_read_reg(i2c, regfile[i], &amp;val);</span><span class="w"></span>
<span class="gi">+		if (ret) {</span><span class="w"></span>
<span class="gi">+			pr_err("%s:%s fail to read muic reg(0x%02x), ret=%d\n",</span><span class="w"></span>
<span class="gi">+					MUIC_DEV_NAME, __func__, regfile[i], ret);</span><span class="w"></span>
<span class="gi">+			continue;</span><span class="w"></span>
<span class="gi">+		}</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+		pr_info("%s:%s reg(0x%02x)=[0x%02x]\n", MUIC_DEV_NAME, __func__,</span><span class="w"></span>
<span class="gi">+				regfile[i], val);</span><span class="w"></span>
<span class="gi">+	}</span><span class="w"></span>
<span class="gi">+	pr_info("%s:%s end register---------------\n", MUIC_DEV_NAME, __func__);</span><span class="w"></span>
<span class="gi">+}</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+static int max77705_muic_attach_uart_path(struct max77705_muic_data *muic_data,</span><span class="w"></span>
<span class="gi">+					muic_attached_dev_t new_dev)</span><span class="w"></span>
<span class="gi">+{</span><span class="w"></span>
<span class="gi">+	struct muic_platform_data *pdata = muic_data-&gt;pdata;</span><span class="w"></span>
<span class="gi">+	int ret = 0;</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+	pr_info("%s:%s\n", MUIC_DEV_NAME, __func__);</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+	if (pdata-&gt;uart_path == MUIC_PATH_UART_AP)</span><span class="w"></span>
<span class="gi">+		ret = switch_to_ap_uart(muic_data, new_dev);</span><span class="w"></span>
<span class="gi">+	else if (pdata-&gt;uart_path == MUIC_PATH_UART_CP)</span><span class="w"></span>
<span class="gi">+		ret = switch_to_cp_uart(muic_data, new_dev);</span><span class="w"></span>
<span class="gi">+	else</span><span class="w"></span>
<span class="gi">+		pr_warn("%s:%s invalid uart_path\n", MUIC_DEV_NAME, __func__);</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+	return ret;</span><span class="w"></span>
<span class="gi">+}</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+#ifdef MANUAL_UART_SWITCH</span><span class="w"></span>
<span class="gi">+static ssize_t max77705_muic_switch_uart(struct device *dev,</span><span class="w"></span>
<span class="gi">+					  struct device_attribute *attr,</span><span class="w"></span>
<span class="gi">+					  const char *buf, size_t count)</span><span class="w"></span>
<span class="gi">+{</span><span class="w"></span>
<span class="gi">+	struct max77705_muic_data *muic_data = dev_get_drvdata(dev);</span><span class="w"></span>
<span class="gi">+	struct muic_platform_data *pdata = muic_data-&gt;pdata;</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+	mutex_lock(&amp;muic_data-&gt;muic_mutex);</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+	if (!strncasecmp(buf, "1", 1)) {</span><span class="w"></span>
<span class="gi">+		max77705_muic_attach_uart_path(muic_data, ATTACHED_DEV_JIG_UART_OFF_MUIC);</span><span class="w"></span>
<span class="gi">+	} else if (!strncasecmp(buf, "0", 1)) {</span><span class="w"></span>
<span class="gi">+		com_to_open(muic_data);</span><span class="w"></span>
<span class="gi">+	} else {</span><span class="w"></span>
<span class="gi">+		pr_warn("Value should be 1 for on, 0 for off\n");</span><span class="w"></span>
<span class="gi">+	}</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+	mutex_unlock(&amp;muic_data-&gt;muic_mutex);</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+	return count;</span><span class="w"></span>
<span class="gi">+}</span><span class="w"></span>
<span class="gi">+#endif</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="w"> </span>static DEVICE_ATTR(uart_sel, 0664, max77705_muic_show_uart_sel,<span class="w"></span>
<span class="w"> </span>		max77705_muic_set_uart_sel);<span class="w"></span>
<span class="gi">+#ifdef MANUAL_UART_SWITCH</span><span class="w"></span>
<span class="gi">+static DEVICE_ATTR(muic_switch_uart, 0220, NULL,</span><span class="w"></span>
<span class="gi">+		max77705_muic_switch_uart);</span><span class="w"></span>
<span class="gi">+#endif</span><span class="w"></span>
<span class="w"> </span>static DEVICE_ATTR(usb_sel, 0664, max77705_muic_show_usb_sel,<span class="w"></span>
<span class="w"> </span>		max77705_muic_set_usb_sel);<span class="w"></span>
<span class="w"> </span>static DEVICE_ATTR(uart_en, 0660, max77705_muic_show_uart_en,<span class="w"></span>
<span class="gu">@@ -1038,6 +1112,9 @@ static struct attribute *max77705_muic_attributes[] = {</span><span class="w"></span>
<span class="w"> </span>	&amp;dev_attr_attached_dev.attr,<span class="w"></span>
<span class="w"> </span>	&amp;dev_attr_otg_test.attr,<span class="w"></span>
<span class="w"> </span>	&amp;dev_attr_apo_factory.attr,<span class="w"></span>
<span class="gi">+	#ifdef MANUAL_UART_SWITCH</span><span class="w"></span>
<span class="gi">+    &amp;dev_attr_muic_switch_uart.attr,</span><span class="w"></span>
<span class="gi">+    #endif</span><span class="w"></span>
<span class="w"> </span>#if defined(CONFIG_HV_MUIC_MAX77705_AFC)<span class="w"></span>
<span class="w"> </span>	&amp;dev_attr_afc_disable.attr,<span class="w"></span>
<span class="w"> </span>#endif /* CONFIG_HV_MUIC_MAX77705_AFC */<span class="w"></span>
<span class="gu">@@ -1054,51 +1131,6 @@ static const struct attribute_group max77705_muic_group = {</span><span class="w"></span>
<span class="w"> </span>	.attrs = max77705_muic_attributes,<span class="w"></span>
<span class="w"> </span>};<span class="w"></span>
<span class="w"> </span>
<span class="gd">-void max77705_muic_read_register(struct i2c_client *i2c)</span><span class="w"></span>
<span class="gd">-{</span><span class="w"></span>
<span class="gd">-	const enum max77705_usbc_reg regfile[] = {</span><span class="w"></span>
<span class="gd">-		MAX77705_USBC_REG_UIC_HW_REV,</span><span class="w"></span>
<span class="gd">-		MAX77705_USBC_REG_USBC_STATUS1,</span><span class="w"></span>
<span class="gd">-		MAX77705_USBC_REG_USBC_STATUS2,</span><span class="w"></span>
<span class="gd">-		MAX77705_USBC_REG_BC_STATUS,</span><span class="w"></span>
<span class="gd">-		MAX77705_USBC_REG_UIC_INT_M,</span><span class="w"></span>
<span class="gd">-	};</span><span class="w"></span>
<span class="gd">-	u8 val;</span><span class="w"></span>
<span class="gd">-	int i, ret;</span><span class="w"></span>
<span class="gd">-</span><span class="w"></span>
<span class="gd">-	pr_info("%s read register--------------\n", __func__);</span><span class="w"></span>
<span class="gd">-	for (i = 0; i &lt; (int)ARRAY_SIZE(regfile); i++) {</span><span class="w"></span>
<span class="gd">-		ret = max77705_muic_read_reg(i2c, regfile[i], &amp;val);</span><span class="w"></span>
<span class="gd">-		if (ret) {</span><span class="w"></span>
<span class="gd">-			pr_err("%s:%s fail to read muic reg(0x%02x), ret=%d\n",</span><span class="w"></span>
<span class="gd">-					MUIC_DEV_NAME, __func__, regfile[i], ret);</span><span class="w"></span>
<span class="gd">-			continue;</span><span class="w"></span>
<span class="gd">-		}</span><span class="w"></span>
<span class="gd">-</span><span class="w"></span>
<span class="gd">-		pr_info("%s:%s reg(0x%02x)=[0x%02x]\n", MUIC_DEV_NAME, __func__,</span><span class="w"></span>
<span class="gd">-				regfile[i], val);</span><span class="w"></span>
<span class="gd">-	}</span><span class="w"></span>
<span class="gd">-	pr_info("%s:%s end register---------------\n", MUIC_DEV_NAME, __func__);</span><span class="w"></span>
<span class="gd">-}</span><span class="w"></span>
<span class="gd">-</span><span class="w"></span>
<span class="gd">-static int max77705_muic_attach_uart_path(struct max77705_muic_data *muic_data,</span><span class="w"></span>
<span class="gd">-					muic_attached_dev_t new_dev)</span><span class="w"></span>
<span class="gd">-{</span><span class="w"></span>
<span class="gd">-	struct muic_platform_data *pdata = muic_data-&gt;pdata;</span><span class="w"></span>
<span class="gd">-	int ret = 0;</span><span class="w"></span>
<span class="gd">-</span><span class="w"></span>
<span class="gd">-	pr_info("%s:%s\n", MUIC_DEV_NAME, __func__);</span><span class="w"></span>
<span class="gd">-</span><span class="w"></span>
<span class="gd">-	if (pdata-&gt;uart_path == MUIC_PATH_UART_AP)</span><span class="w"></span>
<span class="gd">-		ret = switch_to_ap_uart(muic_data, new_dev);</span><span class="w"></span>
<span class="gd">-	else if (pdata-&gt;uart_path == MUIC_PATH_UART_CP)</span><span class="w"></span>
<span class="gd">-		ret = switch_to_cp_uart(muic_data, new_dev);</span><span class="w"></span>
<span class="gd">-	else</span><span class="w"></span>
<span class="gd">-		pr_warn("%s:%s invalid uart_path\n", MUIC_DEV_NAME, __func__);</span><span class="w"></span>
<span class="gd">-</span><span class="w"></span>
<span class="gd">-	return ret;</span><span class="w"></span>
<span class="gd">-}</span><span class="w"></span>
<span class="gd">-</span><span class="w"></span>
<span class="w"> </span>static int max77705_muic_attach_usb_path(struct max77705_muic_data *muic_data,<span class="w"></span>
<span class="w"> </span>					muic_attached_dev_t new_dev)<span class="w"></span>
<span class="w"> </span>{<span class="w"></span>
</pre></div>
<p>This patch will add new sysfs attribute <code>dev_attr_muic_switch_uart.attr</code>, so that MUIC driver will attach uart on '1' write to that attribute, and detach it on '0' write.
</p>
<h3><span class="mw-headline" id="Setup_pmos_to_switch_muic_on_key_combination">Setup pmos to switch muic on key combination</span></h3>
<p>Use <a href="../en/Troubleshooting:HID_buttons.html#Using_triggerhappy_to_handle_HID_input_events" title="Troubleshooting:HID buttons">triggerhappy</a>
</p>
<h3><span class="mw-headline" id="Build_a_cable">Build a cable</span></h3>
<ul><li>determine, on what pins MUIC multiplexes uart, i.e. find TX RX pins on usb.</li></ul>
<p>The process is similar to <a href="../en/Serial_debugging.html#USB-C_based_cables" title="Serial debugging">finding TX RX pins on the PCB</a>
For type-c devices it will likely be either D+D- or SBU pins.
</p>
<ul>
<li>assemble cable</li>
<li>ensure you get an output from your cable, when writing to corresponding tty on the phone</li>
</ul>
<h2><span class="mw-headline" id="Hack_kernel_to_execute_your_bootloader">Hack kernel to execute your bootloader</span></h2>
<ul>
<li>enable <code>CONFIG_DEVMEM</code>
</li>
<li>disable watchdog timer (it forces reboot, if kernel not responds)</li>
</ul>
<p>Simplest way is to delete device tree node, for qcom device usually <code>compatible = "qcom,msm-watchdog";</code>
</p>
<ul><li>apply a patch to launch bootloader from linux</li></ul>
<div class="mw-highlight mw-highlight-lang-diff mw-content-ltr" dir="ltr"><pre><span></span><span class="gh">diff --git a/arch/arm64/kernel/cpu-reset.S b/arch/arm64/kernel/cpu-reset.S</span><span class="w"></span>
<span class="gh">index 65f42d257..86c26955a 100644</span><span class="w"></span>
<span class="gd">--- a/arch/arm64/kernel/cpu-reset.S</span><span class="w"></span>
<span class="gi">+++ b/arch/arm64/kernel/cpu-reset.S</span><span class="w"></span>
<span class="gu">@@ -34,16 +34,15 @@</span><span class="w"></span>
<span class="w"> </span> */<span class="w"></span>
<span class="w"> </span>ENTRY(__cpu_soft_restart)<span class="w"></span>
<span class="w"> </span>	/* Clear sctlr_el1 flags. */<span class="w"></span>
<span class="gd">-	mrs	x12, sctlr_el1</span><span class="w"></span>
<span class="gd">-	ldr	x13, =SCTLR_ELx_FLAGS</span><span class="w"></span>
<span class="gd">-	bic	x12, x12, x13</span><span class="w"></span>
<span class="gd">-	msr	sctlr_el1, x12</span><span class="w"></span>
<span class="gi">+	/* Turn off MMU. Note, we can do that only from .idmap.text section,</span><span class="w"></span>
<span class="gi">+	 * when id mapping installed. For details on MMU shutdown/bring up, see</span><span class="w"></span>
<span class="gi">+	 *</span><span class="w"></span>
<span class="gi">+	 * https://www.programmersought.com/article/82334578227/</span><span class="w"></span>
<span class="gi">+	 * https://stackoverflow.com/questions/30843270/arm-disabling-mmu-and-updating-pc</span><span class="w"></span>
<span class="gi">+	 */</span><span class="w"></span>
<span class="gi">+	msr	sctlr_el1, xzr</span><span class="w"></span>
<span class="w"> </span>	isb<span class="w"></span>
<span class="w"> </span>
<span class="gd">-	cbz	x0, 1f				// el2_switch?</span><span class="w"></span>
<span class="gd">-	mov	x0, #HVC_SOFT_RESTART</span><span class="w"></span>
<span class="gd">-	hvc	#0				// no return</span><span class="w"></span>
<span class="gd">-</span><span class="w"></span>
<span class="w"> </span>1:	mov	x18, x1				// entry<span class="w"></span>
<span class="w"> </span>	mov	x0, x2				// arg0<span class="w"></span>
<span class="w"> </span>	mov	x1, x3				// arg1<span class="w"></span>
<span class="gh">diff --git a/drivers/Makefile b/drivers/Makefile</span><span class="w"></span>
<span class="gh">index c571b2694..f3bbe0729 100644</span><span class="w"></span>
<span class="gd">--- a/drivers/Makefile</span><span class="w"></span>
<span class="gi">+++ b/drivers/Makefile</span><span class="w"></span>
<span class="gu">@@ -5,6 +5,8 @@</span><span class="w"></span>
<span class="w"> </span># Rewritten to use lists instead of if-statements.<span class="w"></span>
<span class="w"> </span>#<span class="w"></span>
<span class="w"> </span>
<span class="gi">+obj-y += jump/</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="w"> </span>obj-y				+= irqchip/<span class="w"></span>
<span class="w"> </span>obj-y				+= bus/<span class="w"></span>
<span class="w"> </span>
<span class="gh">diff --git a/drivers/jump/Makefile b/drivers/jump/Makefile</span><span class="w"></span>
<span class="w">new file mode 100644</span>
<span class="gh">index 000000000..38a3b48cc</span><span class="w"></span>
<span class="gd">--- /dev/null</span><span class="w"></span>
<span class="gi">+++ b/drivers/jump/Makefile</span><span class="w"></span>
<span class="gu">@@ -0,0 +1 @@</span><span class="w"></span>
<span class="gi">+obj-y += jump.o</span><span class="w"></span>
<span class="gh">diff --git a/drivers/jump/jump.c b/drivers/jump/jump.c</span><span class="w"></span>
<span class="w">new file mode 100644</span>
<span class="gh">index 000000000..bbadf123c</span><span class="w"></span>
<span class="gd">--- /dev/null</span><span class="w"></span>
<span class="gi">+++ b/drivers/jump/jump.c</span><span class="w"></span>
<span class="gu">@@ -0,0 +1,114 @@</span><span class="w"></span>
<span class="gi">+/*</span><span class="w"></span>
<span class="gi">+ * Author:  Dzmitry Sankouski &lt;dsankouski@gmail.com&gt;</span><span class="w"></span>
<span class="gi">+ * License terms:  GNU General Public License (GPL), version 2</span><span class="w"></span>
<span class="gi">+ *</span><span class="w"></span>
<span class="gi">+ * Based on kexec code.</span><span class="w"></span>
<span class="gi">+ * Usage:</span><span class="w"></span>
<span class="gi">+ * - read jump_code_buffer physical address from sysfs</span><span class="w"></span>
<span class="gi">+ * - write target code to jump_code_buffer region</span><span class="w"></span>
<span class="gi">+ * - perform write to `jump` file to shutdown linux, and run your code</span><span class="w"></span>
<span class="gi">+ */</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+#include &lt;asm/mmu_context.h&gt;</span><span class="w"></span>
<span class="gi">+#include &lt;linux/cpu.h&gt;</span><span class="w"></span>
<span class="gi">+#include &lt;linux/err.h&gt;</span><span class="w"></span>
<span class="gi">+#include &lt;linux/init.h&gt;</span><span class="w"></span>
<span class="gi">+#include &lt;linux/io.h&gt;</span><span class="w"></span>
<span class="gi">+#include &lt;linux/kobject.h&gt;</span><span class="w"></span>
<span class="gi">+#include &lt;linux/module.h&gt;</span><span class="w"></span>
<span class="gi">+#include &lt;linux/of.h&gt;</span><span class="w"></span>
<span class="gi">+#include &lt;linux/of_address.h&gt;</span><span class="w"></span>
<span class="gi">+#include &lt;linux/platform_device.h&gt;</span><span class="w"></span>
<span class="gi">+#include &lt;linux/reboot.h&gt;</span><span class="w"></span>
<span class="gi">+#include &lt;linux/slab.h&gt;</span><span class="w"></span>
<span class="gi">+#include &lt;linux/spinlock.h&gt;</span><span class="w"></span>
<span class="gi">+#include &lt;linux/types.h&gt;</span><span class="w"></span>
<span class="gi">+#include "../../arch/arm64/kernel/cpu-reset.h"</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+void *jump_code_buffer;</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+static ssize_t jump(struct kobject *kobj, struct kobj_attribute *attr,</span><span class="w"></span>
<span class="gi">+                    const char *buf, size_t count) {</span><span class="w"></span>
<span class="gi">+    unsigned long jump_address;</span><span class="w"></span>
<span class="gi">+    jump_address = __pa(jump_code_buffer);</span><span class="w"></span>
<span class="gi">+    pr_info("Jump to address 0x%p\n", jump_address);</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+    kernel_restart_prepare(NULL);</span><span class="w"></span>
<span class="gi">+    pr_info("Kernel restart prepared\n");</span><span class="w"></span>
<span class="gi">+    migrate_to_reboot_cpu();</span><span class="w"></span>
<span class="gi">+    pr_info("Migrated to reboot cpu\n");</span><span class="w"></span>
<span class="gi">+    /*</span><span class="w"></span>
<span class="gi">+     * migrate_to_reboot_cpu() disables CPU hotplug assuming that</span><span class="w"></span>
<span class="gi">+     * no further code needs to use CPU hotplug (which is true in</span><span class="w"></span>
<span class="gi">+     * the reboot case). However, the kexec path depends on using</span><span class="w"></span>
<span class="gi">+     * CPU hotplug again; so re-enable it here.</span><span class="w"></span>
<span class="gi">+     */</span><span class="w"></span>
<span class="gi">+    /* Do I really need this? */</span><span class="w"></span>
<span class="gi">+    cpu_hotplug_enable();</span><span class="w"></span>
<span class="gi">+    pr_info("Cpu hotplug enabled\n");</span><span class="w"></span>
<span class="gi">+    machine_shutdown();</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+    pr_info("Machine shutdown\n");</span><span class="w"></span>
<span class="gi">+    /* Disable all DAIF exceptions. */</span><span class="w"></span>
<span class="gi">+    asm volatile("msr daifset, #0xf" : : : "memory");</span><span class="w"></span>
<span class="gi">+    pr_info("DAIF exceptions disabled\n");</span><span class="w"></span>
<span class="gi">+    pr_info("Bye!\n");</span><span class="w"></span>
<span class="gi">+    /*</span><span class="w"></span>
<span class="gi">+     * cpu_soft_restart will shutdown the MMU, disable data caches, then</span><span class="w"></span>
<span class="gi">+     * transfer control to the jump_code_buffer which contains user - loaded</span><span class="w"></span>
<span class="gi">+     * code</span><span class="w"></span>
<span class="gi">+     *</span><span class="w"></span>
<span class="gi">+     */</span><span class="w"></span>
<span class="gi">+    cpu_soft_restart(1, jump_address, 0, 0, 0);</span><span class="w"></span>
<span class="gi">+    /* unreachable */</span><span class="w"></span>
<span class="gi">+    return count;</span><span class="w"></span>
<span class="gi">+}</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+static ssize_t show_jump_address(struct kobject *k, struct kobj_attribute *attr,</span><span class="w"></span>
<span class="gi">+                                 char *buf) {</span><span class="w"></span>
<span class="gi">+    unsigned long jump_address;</span><span class="w"></span>
<span class="gi">+    jump_address = __pa(jump_code_buffer);</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+    return sprintf(buf, "0x%p\n", (void *) jump_address);</span><span class="w"></span>
<span class="gi">+}</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+static struct kobj_attribute jump_attr = __ATTR(jump, 0220, NULL, jump);</span><span class="w"></span>
<span class="gi">+static struct kobj_attribute jump_address =</span><span class="w"></span>
<span class="gi">+    __ATTR(show_jump_address, 0440, show_jump_address, NULL);</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+static struct attribute *jump_attributes[] = {</span><span class="w"></span>
<span class="gi">+    &amp;jump_attr.attr,</span><span class="w"></span>
<span class="gi">+    &amp;jump_address.attr,</span><span class="w"></span>
<span class="gi">+    NULL</span><span class="w"></span>
<span class="gi">+};</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+static const struct attribute_group jump_group = {</span><span class="w"></span>
<span class="gi">+    .attrs = jump_attributes,</span><span class="w"></span>
<span class="gi">+};</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+struct kobject *module_kobj;</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+static int __init init_events_group(void) {</span><span class="w"></span>
<span class="gi">+    pr_info("Allocate memory for target code buffer\n");</span><span class="w"></span>
<span class="gi">+    jump_code_buffer = kzalloc(0x100000, GFP_KERNEL);</span><span class="w"></span>
<span class="gi">+    pr_info("reboot code buffer phys address: 0x%p \n", __pa(jump_code_buffer));</span><span class="w"></span>
<span class="gi">+    pr_info("Create sysfs files for jump\n");</span><span class="w"></span>
<span class="gi">+    int ret;</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+    module_kobj = kobject_create_and_add("jump", kernel_kobj);</span><span class="w"></span>
<span class="gi">+    if (!module_kobj) {</span><span class="w"></span>
<span class="gi">+        pr_err("jump: Couldn't create module kobject\n");</span><span class="w"></span>
<span class="gi">+        return -ENOENT;</span><span class="w"></span>
<span class="gi">+    }</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+    ret = sysfs_create_group(module_kobj, &amp;jump_group);</span><span class="w"></span>
<span class="gi">+    if (ret) {</span><span class="w"></span>
<span class="gi">+        pr_err("jump: Failed to create sysfs\n");</span><span class="w"></span>
<span class="gi">+        return ret;</span><span class="w"></span>
<span class="gi">+    }</span><span class="w"></span>
<span class="gi">+    if (ret) kobject_put(module_kobj);</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+    return 0;</span><span class="w"></span>
<span class="gi">+}</span><span class="w"></span>
<span class="gi">+</span><span class="w"></span>
<span class="gi">+late_initcall(init_events_group);</span><span class="w"></span>
</pre></div>
<ul><li>load and run your code with <b>run_file.py</b> script like:</li></ul>
<div class="mw-highlight mw-highlight-lang-python mw-content-ltr" dir="ltr"><pre><span></span><span class="ch">#!/usr/bin/python3</span>

<span class="c1"># Load executable file(bin format, use objcopy to convert obj file to bin),</span>
<span class="c1"># to physical memory, starting from reboot code buffer address, found in kmsg.</span>
<span class="c1">#</span>
<span class="c1"># Then timeout for user to switch from usb cable to debug uart cable</span>
<span class="c1">#</span>
<span class="c1"># After timeout, commands kernel to shutdown, and execute loaded code</span>
<span class="c1">#</span>
<span class="c1"># Remember if you actually need to switch from usb ssh, to debug uart cable, run this script like</span>
<span class="c1"># nohup python run_file.py [file] &amp; tail -f nohup.out</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">base_address</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s2">"sudo cat /sys/kernel/jump/show_jump_address"</span><span class="p">)</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'Found address for code loading: '</span> <span class="o">+</span> <span class="n">base_address</span><span class="p">)</span>

<span class="n">command</span> <span class="o">=</span> <span class="s1">'sudo dd if='</span> <span class="o">+</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">' of=/dev/mem bs=16 seek='</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">base_address</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">'Code loaded...'</span><span class="p">)</span>

<span class="n">timeout</span> <span class="o">=</span> <span class="mi">20</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">' seconds until launch'</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">'go'</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">'sudo bash -c "echo 1 &gt; /sys/kernel/jump/jump"'</span><span class="p">)</span>
</pre></div>
<ul><li>On systems with no python, like TWRP use sh</li></ul>
<div class="mw-highlight mw-highlight-lang-sh mw-content-ltr" dir="ltr"><pre><span></span><span class="ch">#!/bin/sh</span>

<span class="nv">BASE_ADDRESS</span><span class="o">=</span><span class="sb">`</span>cat show_jump_address<span class="sb">`</span>
<span class="nb">echo</span> <span class="s1">'Found address for code loading: '</span><span class="nv">$BASE_ADDRESS</span>

<span class="nv">CMD</span><span class="o">=</span><span class="s1">'sudo dd if='</span><span class="nv">$1</span><span class="s1">' of=/dev/mem bs=16 seek='</span><span class="k">$(</span>expr <span class="k">$(</span><span class="nb">printf</span> <span class="s2">"%d\n"</span> <span class="nv">$BASE_ADDRESS</span><span class="k">)</span> / <span class="m">16</span><span class="k">)</span>
CMD

<span class="nb">echo</span> <span class="s1">'Code loaded...'</span>

<span class="nv">TIMEOUT</span><span class="o">=</span><span class="m">20</span>

<span class="nb">echo</span> <span class="s1">'Waiting for '</span><span class="nv">$TIMEOUT</span><span class="s1">' seconds timeout'</span>
sleep <span class="nv">$TIMEOUT</span>

<span class="nb">echo</span> <span class="s1">'go'</span>

<span class="nb">echo</span> <span class="m">1</span> &gt; /sys/kernel/jump/jump
</pre></div>
<table role="text container" style="color: inherit; background-color: #fdd1d1; border: 1px solid #b60000; margin: 4px 0; border-collapse: collapse;"><tbody><tr>
<td style="padding: 2px 0 2px 0.9em; text-align: center;"><span style="white-space: nowrap;"><img alt="Icon" src="../Red_warning_icon.svg" decoding="async" title="Icon" width="20" height="20" srcset="../Red_warning_icon.svg 1.5x ../Red_warning_icon.svg 2x"></span></td>
<td style="padding: 0.35em 0.9em; width: 100%;">
<b>TODO:</b> add a section to check, that we got uart on usb, and alive payload. We may check payload alive with ARM debug coprocessor. See also <a rel="nofollow" class="external free" href="https://stackoverflow.com/questions/69256603/arm-how-does-linux-decompression-routine-outputs-characters-on-uart">https://stackoverflow.com/questions/69256603/arm-how-does-linux-decompression-routine-outputs-characters-on-uart</a>
</td>
</tr></tbody></table>
<h2><span class="mw-headline" id="Run_bootloader_builds">Run bootloader builds</span></h2>
<ul>
<li>Connect to phone via ssh</li>
<li>Build bootloader bin file, upload it on phone.</li>
<li>Run <code>nohup python3 -u <b>run_file.py</b> [bootloader file] &amp; tail -f nohup.out</code>. It will give you 20 secs timeout to plugin debug uart cable, and switch muic.</li>
<li>After timeout is expired, your bin file will be launched, with MMU disabled.</li>
</ul>
<h2><span class="mw-headline" id="Troubleshooting">Troubleshooting</span></h2>
<h3><span class="mw-headline" id="No_output_from_your_uart">No output from your uart</span></h3>
<h4><span class="mw-headline" id="DMA_uart_mode.">DMA uart mode.</span></h4>
<p>Linux may run uart in DMA mode, instead of FIFO, like typical bootloader. For example, qcom SOCs GENI core uart works in data mover mode, using DMA, so you need to switch it to FIFO mode. Refer to early_con uart setup in linux, setup uart via devmem accordingly
</p>
<h4><span class="mw-headline" id="Uart_is_reset_by_bootloader.">Uart is reset by bootloader.</span></h4>
<p>Refer to early_con uart setup in linux
</p>
<h3><span class="mw-headline" id="Phone_reboots_after_executing_bootloader">Phone reboots after executing bootloader</span></h3>
<p>Turn off watchdog
</p>
</div>
<div class="mw-category-generated" lang="en" dir="ltr"><p><em>This category currently contains no pages or media.</em>
</p></div>
</div>
					<div id="catlinks" class="catlinks" data-mw="interface"><div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Categories</a>: <ul>
<li><a href="../en/Category:Low-level.html" title="Category:Low-level">Low-level</a></li>
<li><a href="../en/Category:Guide.html" title="Category:Guide">Guide</a></li>
<li><a href="../en/Category:Todo_Items.html" title="Category:Todo Items">Todo Items</a></li>
</ul>
</div></div>
				</div>
			</main>
			
		</div>
		<div class="mw-footer-container">
			
<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
	<li data-nosnippet="">Retrieved from "<a dir="ltr" href="https://wiki.postmarketos.org/index.php?title=Category:Bootloaders/Bootloaders_porting_using_linux&amp;oldid=52590">https://wiki.postmarketos.org/index.php?title=Category:Bootloaders/Bootloaders_porting_using_linux&amp;oldid=52590</a>"</li>
<li id="footer-info-lastmod"> This page was last edited on 16 November 2023, at 09:30.</li>
	<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike</a> unless otherwise noted.</li>
<br>
</ul>

	<ul id="footer-places">
	<li id="footer-places-privacy"><a href="../en/PostmarketOS:Privacy_policy.html">Privacy policy</a></li>
	<li id="footer-places-about"><a href="../en/About_postmarketOS.html">About postmarketOS</a></li>
	<li id="footer-places-disclaimer"><a href="../en/PostmarketOS:General_disclaimer.html">Disclaimers</a></li>
</ul>

	<ul id="footer-icons" class="noprint">
	<li id="footer-copyrightico"><a href="https://creativecommons.org/licenses/by-sa/4.0/"><img src="../cc-by-sa.png" alt="Creative Commons Attribution-ShareAlike" width="88" height="31" loading="lazy"></a></li>
	<li id="footer-poweredbyico"><a href="https://www.mediawiki.org/"><img src="../poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" srcset="" width="88" height="31" loading="lazy"></a></li>
</ul>

</footer>

		</div>
	</div> 
</div> 

</body>
</html>
