<!DOCTYPE html>
<html class="client-nojs" dir="ltr" lang="en">
 <head>
  <meta charset="utf-8"/>
  <title>
   USB Internet - postmarketOS
  </title>
  <link href="../PostmarketOSWikiOffline.css" rel="stylesheet"/>
  <meta content="" name="ResourceLoaderDynamicStyles"/>
  <meta content="MediaWiki 1.34.2" name="generator"/>
  <link href="/favicon.ico" rel="shortcut icon"/>
  <link href="/opensearch_desc.php" rel="search" title="postmarketOS (en)" type="application/opensearchdescription+xml"/>
  <link href="https://wiki.postmarketos.org/api.php?action=rsd" rel="EditURI" type="application/rsd+xml"/>
  <link href="https://creativecommons.org/licenses/by-sa/4.0/" rel="license"/>
  <link href="/index.php?title=Special:RecentChanges&amp;feed=atom" rel="alternate" title="postmarketOS Atom feed" type="application/atom+xml"/>
 </head>
 <body class="mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-USB_Internet rootpage-USB_Internet skin-vector action-view">
  <div class="mw-body" id="content" role="main" style="margin: 0">
   <a id="top">
   </a>
   <div class="mw-indicators mw-body-content">
   </div>
   <h1 class="firstHeading" id="firstHeading" lang="en">
    USB Internet
   </h1>
   <div class="mw-body-content" id="bodyContent">
    <div class="noprint" id="siteSub">
     From postmarketOS
    </div>
    <div id="contentSub">
    </div>
    <div id="jump-to-nav">
    </div>
    <a class="mw-jump-link" href="#mw-head">
     Jump to navigation
    </a>
    <a class="mw-jump-link" href="#p-search">
     Jump to search
    </a>
    <div class="mw-content-ltr" dir="ltr" id="mw-content-text" lang="en">
     <div class="mw-parser-output">
      <p>
       You can enable Internet through the USB cable when
       <a href="../en/WiFi.html" title="WiFi">
        WiFi
       </a>
       doesn't work yet on your device. For this to work you set your host machine as gateway for your phone and let your host machine do
       <a class="external text" href="https://en.wikipedia.org/wiki/Network_address_translation" rel="nofollow">
        network address translation (NAT)
       </a>
       for the phone or a guest machine.
      </p>
      <div class="toc" id="toc">
       <input class="toctogglecheckbox" id="toctogglecheckbox" role="button" style="display:none" type="checkbox"/>
       <div class="toctitle" dir="ltr" lang="en">
        <h2>
         Contents
        </h2>
        <span class="toctogglespan">
         <label class="toctogglelabel" for="toctogglecheckbox">
         </label>
        </span>
       </div>
       <ul>
        <li class="toclevel-1 tocsection-1">
         <a href="#On_your_phone_or_guest_machine:">
          <span class="tocnumber">
           1
          </span>
          <span class="toctext">
           On your phone or guest machine:
          </span>
         </a>
         <ul>
          <li class="toclevel-2 tocsection-2">
           <a href="#Linux">
            <span class="tocnumber">
             1.1
            </span>
            <span class="toctext">
             Linux
            </span>
           </a>
          </li>
          <li class="toclevel-2 tocsection-3">
           <a href="#Windows">
            <span class="tocnumber">
             1.2
            </span>
            <span class="toctext">
             Windows
            </span>
           </a>
          </li>
         </ul>
        </li>
        <li class="toclevel-1 tocsection-4">
         <a href="#On_the_host_machine:">
          <span class="tocnumber">
           2
          </span>
          <span class="toctext">
           On the host machine:
          </span>
         </a>
         <ul>
          <li class="toclevel-2 tocsection-5">
           <a href="#iptables_.28Ubuntu.2FArch.2FAlpine.29">
            <span class="tocnumber">
             2.1
            </span>
            <span class="toctext">
             iptables (Ubuntu/Arch/Alpine)
            </span>
           </a>
          </li>
          <li class="toclevel-2 tocsection-6">
           <a href="#firewalld_.28RHEL.2FCentOS.2FFedora.2FRocky.2FSLE.2FopenSUSE.29">
            <span class="tocnumber">
             2.2
            </span>
            <span class="toctext">
             firewalld (RHEL/CentOS/Fedora/Rocky/SLE/openSUSE)
            </span>
           </a>
          </li>
          <li class="toclevel-2 tocsection-7">
           <a href="#nftables_.28postmarketOS.29">
            <span class="tocnumber">
             2.3
            </span>
            <span class="toctext">
             nftables (postmarketOS)
            </span>
           </a>
          </li>
          <li class="toclevel-2 tocsection-8">
           <a href="#ufw">
            <span class="tocnumber">
             2.4
            </span>
            <span class="toctext">
             ufw
            </span>
           </a>
          </li>
         </ul>
        </li>
        <li class="toclevel-1 tocsection-9">
         <a href="#Notes">
          <span class="tocnumber">
           3
          </span>
          <span class="toctext">
           Notes
          </span>
         </a>
        </li>
       </ul>
      </div>
      <h4>
       <span class="mw-headline" id="On_your_phone_or_guest_machine:">
        On your phone or guest machine:
       </span>
      </h4>
      <table role="text container" style="color: inherit; background-color: #f6efe5; border: 1px solid #ac6600; margin: 4px 0; border-collapse: collapse;">
       <tbody>
        <tr>
         <td style="padding: 2px 0 2px 0.9em; text-align: center;">
          <span style="white-space: nowrap;">
           <img alt="Note" decoding="async" height="20" src="../Reference_icon.svg" srcset="../Reference_icon.svg 1.5x ../Reference_icon.svg 2x" title="Note" width="20"/>
          </span>
         </td>
         <td style="padding: 0.35em 0.9em; width: 100%;">
          <b>
           Note:
          </b>
          <code>
           1.1.1.1
          </code>
          and
          <code>
           1.0.0.1
          </code>
          are the DNS servers, feel free to change it if you wish.
         </td>
        </tr>
       </tbody>
      </table>
      <h5>
       <span class="mw-headline" id="Linux">
        Linux
       </span>
      </h5>
      <table role="text container" style="color: inherit; background-color: #f6efe5; border: 1px solid #ac6600; margin: 4px 0; border-collapse: collapse;">
       <tbody>
        <tr>
         <td style="padding: 2px 0 2px 0.9em; text-align: center;">
          <span style="white-space: nowrap;">
           <img alt="Note" decoding="async" height="20" src="../Reference_icon.svg" srcset="../Reference_icon.svg 1.5x ../Reference_icon.svg 2x" title="Note" width="20"/>
          </span>
         </td>
         <td style="padding: 0.35em 0.9em; width: 100%;">
          <b>
           Note:
          </b>
          It works in both sides: to share Internet from your phone to PC (aka USB tethering), just swap host and phone below and use
          <code>
           172.16.42.1
          </code>
          .
         </td>
        </tr>
       </tbody>
      </table>
      <p>
       <code>
        ip
       </code>
       is used on the most of recent distros. For legacy commands, use
       <code>
        route add default gw 172.16.42.2
       </code>
       .
      </p>
      <div class="mw-highlight mw-content-ltr" dir="ltr">
       <pre><span></span><span class="gp">#</span> ip route add default via <span class="m">172</span>.16.42.2
<span class="gp">#</span> <span class="nb">echo</span> nameserver <span class="m">1</span>.1.1.1 &gt; /etc/resolv.conf
</pre>
      </div>
      <p>
       To make the configuration persistent after reboot do:
      </p>
      <div class="mw-highlight mw-content-ltr" dir="ltr">
       <pre><span></span><span class="gp">#</span> <span class="nb">echo</span> <span class="s1">'ip route add default via 172.16.42.2'</span> &gt; /etc/local.d/usb_internet.start
<span class="gp">#</span> chmod +x /etc/local.d/usb_internet.start
<span class="gp">#</span> rc-update add <span class="nb">local</span>
</pre>
      </div>
      <p>
       Disable it if you plug the USB cable out and want to use WiFi, because it can interfere with routing (packets would try to use the USB networking, even though it's disconnected)
      </p>
      <h5>
       <span class="mw-headline" id="Windows">
        Windows
       </span>
      </h5>
      <p>
       <a class="image" href="../Windows_usb_internet.png">
        <img alt="Windows usb internet.png" decoding="async" height="462" src="../Windows_usb_internet.png" width="414"/>
       </a>
      </p>
      <p>
       Configure the IP addresses like the screenshot above.
       <sup class="reference" id="cite_ref-1">
        <a href="#cite_note-1">
         [1]
        </a>
       </sup>
      </p>
      <h4>
       <span class="mw-headline" id="On_the_host_machine:">
        On the host machine:
       </span>
      </h4>
      <p>
       Fisrt, enable IP forwarding:
      </p>
      <div class="mw-highlight mw-content-ltr" dir="ltr">
       <pre><span></span><span class="gp">#</span> sysctl net.ipv4.ip_forward<span class="o">=</span><span class="m">1</span>
</pre>
      </div>
      <p>
       Then follow the instructions according to the distribution or firewall you use.
      </p>
      <h5>
       <span id="iptables_(Ubuntu/Arch/Alpine)">
       </span>
       <span class="mw-headline" id="iptables_.28Ubuntu.2FArch.2FAlpine.29">
        iptables (Ubuntu/Arch/Alpine)
       </span>
      </h5>
      <div class="mw-highlight mw-content-ltr" dir="ltr">
       <pre><span></span><span class="gp">#</span> iptables -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
<span class="gp">#</span> iptables -A FORWARD -s <span class="m">172</span>.16.42.0/24 -j ACCEPT
<span class="gp">#</span> iptables -A POSTROUTING -t nat -j MASQUERADE -s <span class="m">172</span>.16.42.0/24
<span class="gp">#</span> iptables-save <span class="c1">#Save changes</span>
</pre>
      </div>
      <p>
       This will enable IPv4 forwarding on your host machine which basically lets it function as a router. The postrouting command will make the kernel on the host translate the packets between the phone network
and your normal network on the host machine.
      </p>
      <h5>
       <span id="firewalld_(RHEL/CentOS/Fedora/Rocky/SLE/openSUSE)">
       </span>
       <span class="mw-headline" id="firewalld_.28RHEL.2FCentOS.2FFedora.2FRocky.2FSLE.2FopenSUSE.29">
        firewalld (RHEL/CentOS/Fedora/Rocky/SLE/openSUSE)
       </span>
      </h5>
      <div class="mw-highlight mw-content-ltr" dir="ltr">
       <pre><span></span><span class="gp">#</span> firewall-cmd --get-active-zone 
<span class="gp">#</span> nmcli connection modify ethX_other connection.zone external
<span class="gp">#</span> nmcli connection modify ethX_to_phone connection.zone internal
<span class="gp">#</span> firewall-cmd --get-active-zone 
<span class="gp">#</span> firewall-cmd --zone<span class="o">=</span>external --add-masquerade
<span class="gp">#</span> firewall-cmd --zone<span class="o">=</span>external --list-all
<span class="gp">#</span> firewall-cmd --zone<span class="o">=</span>internal --list-all
</pre>
      </div>
      <p>
       Use the
       <code>
        --permanent
       </code>
       and
       <code>
        --reload
       </code>
       options for a persistent configuration.
       <sup class="reference" id="cite_ref-2">
        <a href="#cite_note-2">
         [2]
        </a>
       </sup>
      </p>
      <h5>
       <span id="nftables_(postmarketOS)">
       </span>
       <span class="mw-headline" id="nftables_.28postmarketOS.29">
        nftables (postmarketOS)
       </span>
      </h5>
      <div class="mw-highlight mw-content-ltr" dir="ltr">
       <pre><span></span><span class="gp">#</span> nft add table inet nat
<span class="gp">#</span> nft <span class="s1">'add chain inet nat postrouting { type nat hook postrouting priority 100 ; }'</span>
<span class="gp">#</span> nft add rule inet nat postrouting iifname <span class="s2">"usb*"</span> masquerade
</pre>
      </div>
      <p>
       postmarketOS has chain
       <code>
        forward
       </code>
       configured for USB interfaces by default.
       <sup class="reference" id="cite_ref-3">
        <a href="#cite_note-3">
         [3]
        </a>
       </sup>
       If using other distributions or the following lines are missing, add them manually.
      </p>
      <div class="mw-highlight mw-content-ltr" dir="ltr">
       <pre><span></span><span class="gp">#</span> nft add rule inet filter forward ct state <span class="o">{</span> established, related <span class="o">}</span> accept
<span class="gp">#</span> nft add rule inet filter forward iifname <span class="s2">"usb*"</span> accept
</pre>
      </div>
      <p>
       You can now verify the Internet connection on your phone by pinging something. If this does not work it means you need to compile the kernel with
       <code>
        <a href="../en/Kernel_configuration.html#CONFIG_USB_ETH" title="Kernel configuration">
         CONFIG_USB_ETH
        </a>
       </code>
       setting enabled in menuconfig.
      </p>
      <h5>
       <span class="mw-headline" id="ufw">
        ufw
       </span>
      </h5>
      <p>
       In the file
       <code>
        /etc/default/ufw
       </code>
       , change
       <code>
        DEFAULT_FORWARD_POLICY
       </code>
       to
       <code>
        ACCEPT
       </code>
       .
      </p>
      <div class="mw-highlight mw-content-ltr" dir="ltr">
       <pre><span></span><span class="na">DEFAULT_FORWARD_POLICY</span><span class="o">=</span><span class="s">"ACCEPT"</span>
</pre>
      </div>
      <p>
       In the file
       <code>
        /etc/ufw/sysctl.conf
       </code>
       , uncomment
       <code>
        net/ipv4/ip_forward=1
       </code>
       .
      </p>
      <div class="mw-highlight mw-content-ltr" dir="ltr">
       <pre><span></span><span class="na">net/ipv4/ip_forward</span><span class="o">=</span><span class="s">1</span>
<span class="c1">#net/ipv6/conf/default/forwarding=1</span>
<span class="c1">#net/ipv6/conf/all/forwarding=1</span>
</pre>
      </div>
      <p>
       Add the following rule to
       <code>
        /etc/ufw/before.rules
       </code>
       BEFORE the
       <code>
        *filter
       </code>
       table rules.
      </p>
      <div class="mw-highlight mw-content-ltr" dir="ltr">
       <pre><span></span><span class="c1"># NAT table rules</span>
<span class="na">*nat</span>
<span class="na">:POSTROUTING ACCEPT [0:0]</span>

<span class="c1"># Forward traffic for 172.16.42.0/24</span>
<span class="na">-A POSTROUTING -j MASQUERADE -s 172.16.42.0/24</span>

<span class="c1"># don't delete the 'COMMIT' line or these rules won't be processed</span>
<span class="na">COMMIT</span>
</pre>
      </div>
      <p>
       Restart
       <code>
        ufw
       </code>
       to make changes take effect.
      </p>
      <div class="mw-highlight mw-content-ltr" dir="ltr">
       <pre><span></span><span class="gp">#</span> ufw disable <span class="o">&amp;&amp;</span> ufw <span class="nb">enable</span>
</pre>
      </div>
      <h2>
       <span class="mw-headline" id="Notes">
        Notes
       </span>
      </h2>
      <div class="mw-references-wrap">
       <ol class="references">
        <li id="cite_note-1">
         <span class="mw-cite-backlink">
          <a href="#cite_ref-1">
           ↑
          </a>
         </span>
         <span class="reference-text">
          <a class="external free" href="https://support.microsoft.com/en-us/windows/change-tcp-ip-settings-bd0a07af-15f5-cd6a-363f-ca2b6f391ace" rel="nofollow">
           https://support.microsoft.com/en-us/windows/change-tcp-ip-settings-bd0a07af-15f5-cd6a-363f-ca2b6f391ace
          </a>
         </span>
        </li>
        <li id="cite_note-2">
         <span class="mw-cite-backlink">
          <a href="#cite_ref-2">
           ↑
          </a>
         </span>
         <span class="reference-text">
          <a class="external free" href="https://www.server-world.info/en/note?os=CentOS_7&amp;p=firewalld&amp;f=2" rel="nofollow">
           https://www.server-world.info/en/note?os=CentOS_7&amp;p=firewalld&amp;f=2
          </a>
         </span>
        </li>
        <li id="cite_note-3">
         <span class="mw-cite-backlink">
          <a href="#cite_ref-3">
           ↑
          </a>
         </span>
         <span class="reference-text">
          <a class="external free" href="https://gitlab.com/postmarketOS/pmaports/-/blob/master/main/postmarketos-config-nftables/rules/51_usb_inet.nft" rel="nofollow">
           https://gitlab.com/postmarketOS/pmaports/-/blob/master/main/postmarketos-config-nftables/rules/51_usb_inet.nft
          </a>
         </span>
        </li>
       </ol>
      </div>
     </div>
    </div>
    <div class="catlinks" data-mw="interface" id="catlinks">
     <div class="mw-normal-catlinks" id="mw-normal-catlinks">
      <a href="../Special:Categories.html" title="Special:Categories">
       Category
      </a>
      :
      <ul>
       <li>
        <a href="../en/Category:Guide.html" title="Category:Guide">
         Guide
        </a>
       </li>
      </ul>
     </div>
    </div>
    <div class="visualClear">
    </div>
   </div>
  </div>
  <div id="footer" role="contentinfo" style="margin: 0">
   <ul id="footer-info">
    <li>
     Retrieved from "
     <a dir="ltr" href="https://wiki.postmarketos.org/index.php?title=USB_Internet&amp;oldid=29900">
      https://wiki.postmarketos.org/index.php?title=USB_Internet&amp;oldid=29900
     </a>
     "
    </li>
    <li id="footer-info-lastmod">
     This page was last edited on 1 August 2022, at 16:04.
    </li>
    <li id="footer-info-copyright">
     Content is available under
     <a class="external" href="https://creativecommons.org/licenses/by-sa/4.0/" rel="nofollow">
      Creative Commons Attribution-ShareAlike
     </a>
     unless otherwise noted.
    </li>
    <br/>
   </ul>
   <ul id="footer-places">
    <li id="footer-places-privacy">
     <a href="../en/PostmarketOS:Privacy_policy.html" title="PostmarketOS:Privacy policy">
      Privacy policy
     </a>
    </li>
    <li id="footer-places-about">
     <a class="mw-redirect" href="../en/About_postmarketOS.html" title="PostmarketOS:About">
      About postmarketOS
     </a>
    </li>
    <li id="footer-places-disclaimer">
     <a href="../en/PostmarketOS:General_disclaimer.html" title="PostmarketOS:General disclaimer">
      Disclaimers
     </a>
    </li>
    <li id="footer-places-mobileview">
     <a class="noprint stopMobileRedirectToggle" href="https://wiki.postmarketos.org/index.php?title=USB_Internet&amp;mobileaction=toggle_view_mobile">
      Mobile view
     </a>
    </li>
   </ul>
   <ul class="noprint" id="footer-icons">
    <li id="footer-copyrightico">
     <a href="https://creativecommons.org/licenses/by-sa/4.0/">
      <img alt="Creative Commons Attribution-ShareAlike" height="31" src="../cc-by-sa.png" width="88"/>
     </a>
    </li>
    <li id="footer-poweredbyico">
     <a href="https://www.mediawiki.org/">
      <img alt="Powered by MediaWiki" height="31" src="../poweredby_mediawiki_88x31.png" srcset="" width="88"/>
     </a>
    </li>
   </ul>
   <div style="clear: both;">
   </div>
  </div>
 </body>
</html>
