<!DOCTYPE html>
<html class="client-nojs" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>Troubleshooting:display - postmarketOS</title>
<link rel="stylesheet" href="../PostmarketOSWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.34.2">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="postmarketOS (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.postmarketos.org/api.php?action=rsd">
<link rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">
<link rel="alternate" type="application/atom+xml" title="postmarketOS Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Troubleshooting_display rootpage-Troubleshooting_display skin-vector action-view">
<div id="content" class="mw-body" role="main" style="margin: 0">
	<a id="top"></a>
	
	<div class="mw-indicators mw-body-content">
</div>

	<h1 id="firstHeading" class="firstHeading" lang="en">Troubleshooting:display</h1>
	
	<div id="bodyContent" class="mw-body-content">
		<div id="siteSub" class="noprint">From postmarketOS</div>
		<div id="contentSub"></div>
		
		
		
		<div id="jump-to-nav"></div>
		<a class="mw-jump-link" href="#mw-head">Jump to navigation</a>
		<a class="mw-jump-link" href="#p-search">Jump to search</a>
		<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr"><div class="mw-parser-output">
<div id="toc" class="toc">
<input type="checkbox" role="button" id="toctogglecheckbox" class="toctogglecheckbox" style="display:none"><div class="toctitle" lang="en" dir="ltr">
<h2>Contents</h2>
<span class="toctogglespan"><label class="toctogglelabel" for="toctogglecheckbox"></label></span>
</div>
<ul>
<li class="toclevel-1 tocsection-1">
<a href="#Generic_debugging_steps"><span class="tocnumber">1</span> <span class="toctext">Generic debugging steps</span></a>
<ul>
<li class="toclevel-2 tocsection-2"><a href="#Look_at_.7E.2F.xsession-errors_and_.7E.2F.xsession-errors.old"><span class="tocnumber">1.1</span> <span class="toctext">Look at ~/.xsession-errors and ~/.xsession-errors.old</span></a></li>
<li class="toclevel-2 tocsection-3"><a href="#Changing_the_panning"><span class="tocnumber">1.2</span> <span class="toctext">Changing the panning</span></a></li>
<li class="toclevel-2 tocsection-4"><a href="#LightDM_no_longer_starts_Xorg_on_device_without_GPU_driver"><span class="tocnumber">1.3</span> <span class="toctext">LightDM no longer starts Xorg on device without GPU driver</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-5">
<a href="#Generic_troubleshooting_.28any_manufacturer.29"><span class="tocnumber">2</span> <span class="toctext">Generic troubleshooting (any manufacturer)</span></a>
<ul>
<li class="toclevel-2 tocsection-6"><a href="#Screen_does_not_refresh"><span class="tocnumber">2.1</span> <span class="toctext">Screen does not refresh</span></a></li>
<li class="toclevel-2 tocsection-7">
<a href="#Colors_are_wrong_in_some_way"><span class="tocnumber">2.2</span> <span class="toctext">Colors are wrong in some way</span></a>
<ul>
<li class="toclevel-3 tocsection-8"><a href="#Qualcomm_MSM_devices"><span class="tocnumber">2.2.1</span> <span class="toctext">Qualcomm MSM devices</span></a></li>
<li class="toclevel-3 tocsection-9"><a href="#Exynos_devices"><span class="tocnumber">2.2.2</span> <span class="toctext">Exynos devices</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-10">
<a href="#Qualcomm_framebuffer_.28mdss.2C_mdp3.29"><span class="tocnumber">3</span> <span class="toctext">Qualcomm framebuffer (mdss, mdp3)</span></a>
<ul>
<li class="toclevel-2 tocsection-11"><a href="#MSM_framebuffer_doesn.27t_work"><span class="tocnumber">3.1</span> <span class="toctext">MSM framebuffer doesn't work</span></a></li>
<li class="toclevel-2 tocsection-12"><a href="#Screen_output_flicker_and_inactivity"><span class="tocnumber">3.2</span> <span class="toctext">Screen output flicker and inactivity</span></a></li>
<li class="toclevel-2 tocsection-13"><a href="#Screen_output_messed_up"><span class="tocnumber">3.3</span> <span class="toctext">Screen output messed up</span></a></li>
<li class="toclevel-2 tocsection-14"><a href="#Screen_is_blank_outside_of_Weston"><span class="tocnumber">3.4</span> <span class="toctext">Screen is blank outside of Weston</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-15">
<a href="#Debugging_the_kernel_driver"><span class="tocnumber">4</span> <span class="toctext">Debugging the kernel driver</span></a>
<ul>
<li class="toclevel-2 tocsection-16"><a href="#Example:_error_in_Xorg.0.log"><span class="tocnumber">4.1</span> <span class="toctext">Example: error in Xorg.0.log</span></a></li>
<li class="toclevel-2 tocsection-17"><a href="#Example:_red_and_blue_colors_are_swapped"><span class="tocnumber">4.2</span> <span class="toctext">Example: red and blue colors are swapped</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-18"><a href="#See_also"><span class="tocnumber">5</span> <span class="toctext">See also</span></a></li>
</ul>
</div>

<h1><span class="mw-headline" id="Generic_debugging_steps">Generic debugging steps</span></h1>
<h2>
<span id="Look_at_~/.xsession-errors_and_~/.xsession-errors.old"></span><span class="mw-headline" id="Look_at_.7E.2F.xsession-errors_and_.7E.2F.xsession-errors.old">Look at ~/.xsession-errors and ~/.xsession-errors.old</span>
</h2>
<p>When lightDM starts your session, it redirects its output in that file. Including if that's a Wayland session!
</p>
<p>If both files are empty, you can expect your graphical interface to have started without error. If they aren't created, lightDM may not have been started successfully. You can also try this: <a href="../en/Display_manager.html#CanGraphical_issue" title="Display manager">Display_manager#CanGraphical_issue</a> .
</p>
<h2><span class="mw-headline" id="Changing_the_panning">Changing the panning</span></h2>
<p>Some devices might have a framebuffer virtual size that's twice as big as the panel resolution, this is a common double buffering method. The application renders to one side of the display while the panning is set to
the other side. You can try changing the panning with the `panning` file in the sysfs directory.
</p>
<div class="mw-highlight mw-content-ltr" dir="ltr"><pre><span></span><span class="gp">$</span> cat /sys/class/graphics/fb0/virtual_size
<span class="go">todo: add file contents here</span>
<span class="gp">$</span> cat /sys/class/graphics/fb0/pan
<span class="go">todo: add file contents here</span>
<span class="gp">$</span> <span class="nb">echo</span> <span class="m">0</span> <span class="m">0</span> &gt; /sys/class/graphics/fb0/pan
</pre></div>
<h2><span class="mw-headline" id="LightDM_no_longer_starts_Xorg_on_device_without_GPU_driver">LightDM no longer starts Xorg on device without GPU driver</span></h2>
<p>Set <code>logind-check-graphical=false</code> in <code>/usr/share/lightdm/lightdm.conf.d/some-file.conf</code>.
</p>
<p>See also: <a rel="nofollow" class="external free" href="https://gitlab.com/postmarketOS/pmaports/-/merge_requests/3827">https://gitlab.com/postmarketOS/pmaports/-/merge_requests/3827</a>, <a rel="nofollow" class="external free" href="https://github.com/canonical/lightdm/commit/77a7c6b7b8ca896b98ef43826641bdd520650bfb">https://github.com/canonical/lightdm/commit/77a7c6b7b8ca896b98ef43826641bdd520650bfb</a>
</p>
<h1>
<span id="Generic_troubleshooting_(any_manufacturer)"></span><span class="mw-headline" id="Generic_troubleshooting_.28any_manufacturer.29">Generic troubleshooting (any manufacturer)</span>
</h1>
<h2><span class="mw-headline" id="Screen_does_not_refresh">Screen does not refresh</span></h2>
<p>Symptoms of this problem may, for instance, be that the desktop environment starts and is displayed with initial content, but is frozen at that moment and never updates. At first it may seem to be a touchscreen problem, but the lack of automatic changes (e.g. clock showing current time) can point of frozen display instead.
</p>
<p>Check if your screen refreshes when you do the following:
</p>
<div class="mw-highlight mw-content-ltr" dir="ltr"><pre><span></span><span class="gp">$</span> cat /sys/class/graphics/fb0/modes &gt; /sys/class/graphics/fb0/mode
</pre></div>
<p>If it does, add <code>msm-fb-refresher</code> to the <code>depends=</code> of your device-package. It will basically do the same automatically. Despite the name, the tool is not specific to MSM at all.
</p>
<p>(If the above command does <i>not</i> refresh your screen, you could try the <code>msm-fb-refresher</code> anyway.)
</p>
<table role="text container" style="color: inherit; background-color: #f6efe5; border: 1px solid #ac6600; margin: 4px 0; border-collapse: collapse;"><tbody><tr>
<td style="padding: 2px 0 2px 0.9em; text-align: center;"><span style="white-space: nowrap;"><img alt="Note" src="../Reference_icon.svg" decoding="async" title="Note" width="20" height="20" srcset="../Reference_icon.svg 1.5x ../Reference_icon.svg 2x"></span></td>
<td style="padding: 0.35em 0.9em; width: 100%;">Make sure you zap the device rootfs after enabling the msm refresher, otherwise it will only get installed as a service and not enabled by the postmarketos-base install script (you'll only see a second of splash-screen otherwise and the refresher won't be restarted after exiting the initramfs</td>
</tr></tbody></table>
<h2><span class="mw-headline" id="Colors_are_wrong_in_some_way">Colors are wrong in some way</span></h2>
<p>Different framebuffer modes exist where the order of colors and transparency differ. Typically you have R (red) G (green) B (blue) and A (transparency), and they might be supplied as RGBA, BGRA, ARGB or another variant. If the order is wrong you can have different issues:
</p>
<ul>
<li>Everything is red-ish: <a rel="nofollow" class="external text" href="https://imgur.com/a/izehE">example</a>
</li>
<li>Blue and red are swapped: <a rel="nofollow" class="external text" href="https://gitlab.com/postmarketOS/pmaports/uploads/4cfb043d46ef1c0fa0d50484a66062ea/image0__1_.jpg">example</a>
</li>
<li>Screen appears to show nothing (observed by switching from RGBA (which is correct) to ARGB)</li>
</ul>
<p>To try to find a fix you need to locate the place(s) where the order is defined or set, somewhere in drivers/video. If the suggested patches in the subsections below do not work for you then have a look in the <a href="../en/Troubleshooting:display.html#Debugging_the_kernel_driver" title="Troubleshooting:display">Debugging the kernel driver</a>-section.
</p>
<h3><span class="mw-headline" id="Qualcomm_MSM_devices">Qualcomm MSM devices</span></h3>
<p>On Qualcomm devices the correct file should be <code>drivers/video/msm/msm_fb.c</code> or <code>drivers/video/msm/mdss/mdss_fb.c</code>. Changing the mode can (hopefully) be done in one of the following ways:
</p>
<div class="mw-highlight mw-content-ltr" dir="ltr"><pre><span></span><span class="gh">diff --git a/drivers/video/msm/mdss/mdss_fb.c b/drivers/video/msm/mdss/mdss_fb.c</span>
<span class="gh">index 53112ca6..69673017 100644</span>
<span class="gd">--- a/drivers/video/msm/mdss/mdss_fb.c</span>
<span class="gi">+++ b/drivers/video/msm/mdss/mdss_fb.c</span>
<span class="gu">@@ -569,7 +569,7 @@ static int mdss_fb_probe(struct platform_device *pdev)</span>
 	mfd-&gt;bl_level = 0;
 	mfd-&gt;bl_scale = 1024;
	mfd-&gt;bl_min_lvl = 30;
<span class="gd">-	mfd-&gt;fb_imgType = MDP_RGBA_8888;</span>
<span class="gi">+	mfd-&gt;fb_imgType = MDP_RGB_888;</span>
 
 	mfd-&gt;pdev = pdev;
 	if (pdata-&gt;next)
</pre></div>
<p>imgType could also be <code>MDP_RGBA_8888</code> like with <a rel="nofollow" class="external text" href="https://wiki.postmarketos.org/wiki/Motorola_Moto_E_2014_(motorola-condor)">motorola-condor</a> and probably some other MSM8210 devices
</p>
<p>Alternative patch (requires <code>CONFIG_FB_MSM_DEFAULT_DEPTH_ARGB8888=y</code> in the kernel config):
</p>
<div class="mw-highlight mw-content-ltr" dir="ltr"><pre><span></span>From [https://cascardo.eti.br/patches/0001-fix-video-argb-setting.patch 0001-fix-video-argb-setting.patch]
<span class="gh">diff --git a/drivers/video/msm/msm_fb.c b/drivers/video/msm/msm_fb.c</span>
<span class="gh">index 251a5cbb753d..dcd9262a88f4 100644</span>
<span class="gd">--- a/drivers/video/msm/msm_fb.c</span>
<span class="gi">+++ b/drivers/video/msm/msm_fb.c</span>
<span class="gu">@@ -1342,16 +1342,16 @@ static int msm_fb_register(struct msm_fb_data_type *mfd)</span>
 		fix-&gt;xpanstep = 1;
 		fix-&gt;ypanstep = 1;
 		var-&gt;vmode = FB_VMODE_NONINTERLACED;
<span class="gd">-		var-&gt;blue.offset = 0;</span>
<span class="gd">-		var-&gt;green.offset = 8;</span>
<span class="gd">-		var-&gt;red.offset = 16;</span>
<span class="gi">+		var-&gt;blue.offset = 24;</span>
<span class="gi">+		var-&gt;green.offset = 16;</span>
<span class="gi">+		var-&gt;red.offset = 8;</span>
 		var-&gt;blue.length = 8;
 		var-&gt;green.length = 8;
 		var-&gt;red.length = 8;
 		var-&gt;blue.msb_right = 0;
 		var-&gt;green.msb_right = 0;
 		var-&gt;red.msb_right = 0;
<span class="gd">-		var-&gt;transp.offset = 24;</span>
<span class="gi">+		var-&gt;transp.offset = 0;</span>
 		var-&gt;transp.length = 8;
 		bpp = 4;
 		break;
<span class="gu">@@ -1361,16 +1361,16 @@ static int msm_fb_register(struct msm_fb_data_type *mfd)</span>
 		fix-&gt;xpanstep = 1;
 		fix-&gt;ypanstep = 1;
 		var-&gt;vmode = FB_VMODE_NONINTERLACED;
<span class="gd">-		var-&gt;blue.offset = 8;</span>
<span class="gd">-		var-&gt;green.offset = 16;</span>
<span class="gd">-		var-&gt;red.offset = 24;</span>
<span class="gi">+		var-&gt;blue.offset = 16;</span>
<span class="gi">+		var-&gt;green.offset = 8;</span>
<span class="gi">+		var-&gt;red.offset = 0;</span>
 		var-&gt;blue.length = 8;
 		var-&gt;green.length = 8;
 		var-&gt;red.length = 8;
 		var-&gt;blue.msb_right = 0;
 		var-&gt;green.msb_right = 0;
 		var-&gt;red.msb_right = 0;
<span class="gd">-		var-&gt;transp.offset = 0;</span>
<span class="gi">+		var-&gt;transp.offset = 24;</span>
 		var-&gt;transp.length = 8;
 		bpp = 4;
 		break;
<span class="gu">@@ -2260,15 +2260,15 @@ static int msm_fb_check_var(struct fb_var_screeninfo *var, struct fb_info *info)</span>
 		/* Figure out if the user meant RGBA or ARGB
 		   and verify the position of the RGB components */
 
<span class="gd">-		if (var-&gt;transp.offset == 24) {</span>
<span class="gd">-			if ((var-&gt;blue.offset != 0) ||</span>
<span class="gd">-			    (var-&gt;green.offset != 8) ||</span>
<span class="gd">-			    (var-&gt;red.offset != 16))</span>
<span class="gd">-				return -EINVAL;</span>
<span class="gd">-		} else if (var-&gt;transp.offset == 0) {</span>
<span class="gd">-			if ((var-&gt;blue.offset != 8) ||</span>
<span class="gi">+		if (var-&gt;transp.offset == 0) {</span>
<span class="gi">+			if ((var-&gt;blue.offset != 24) ||</span>
 			    (var-&gt;green.offset != 16) ||
<span class="gd">-			    (var-&gt;red.offset != 24))</span>
<span class="gi">+			    (var-&gt;red.offset != 8))</span>
<span class="gi">+				return -EINVAL;</span>
<span class="gi">+		} else if (var-&gt;transp.offset == 24) {</span>
<span class="gi">+			if ((var-&gt;blue.offset != 16) ||</span>
<span class="gi">+			    (var-&gt;green.offset != 8) ||</span>
<span class="gi">+			    (var-&gt;red.offset != 0))</span>
 				return -EINVAL;
 		} else
 			return -EINVAL;
<span class="gu">@@ -2365,7 +2365,7 @@ static int msm_fb_set_par(struct fb_info *info)</span>
 		break;
 
 	case 32:
<span class="gd">-		if (var-&gt;transp.offset == 24)</span>
<span class="gi">+		if (var-&gt;transp.offset == 0)</span>
 			mfd-&gt;fb_imgType = MDP_ARGB_8888;
 		else
 			mfd-&gt;fb_imgType = MDP_RGBA_8888;
</pre></div>
<p>You might also need to add the mode, as done for <a rel="nofollow" class="external text" href="https://gitlab.com/postmarketOS/pmaports/-/blob/64035ac46307bd27888efc0d3af841936e9dee7b/device/testing/linux-xiaomi-santoni/99_framebuffer.patch">linux-xiaomi-santoni</a>:
</p>
<div class="mw-highlight mw-content-ltr" dir="ltr"><pre><span></span><span class="gh">diff --git a/drivers/video/msm/mdss/mdss_fb.c b/drivers/video/msm/mdss/mdss_fb.c</span>
<span class="gh">index 075ee8a3880..b4531f66a06 100644</span>
<span class="gd">--- a/drivers/video/msm/mdss/mdss_fb.c</span>
<span class="gi">+++ b/drivers/video/msm/mdss/mdss_fb.c</span>
<span class="gu">@@ -868,7 +868,8 @@ static int mdss_fb_probe(struct platform_device *pdev)</span>
 	mfd-&gt;bl_scale = 1024;
 	mfd-&gt;bl_min_lvl = 30;
 	mfd-&gt;ad_bl_level = 0;
<span class="gd">-	mfd-&gt;fb_imgType = MDP_RGBA_8888;</span>
<span class="gi">+	// Default framebuffer format.</span>
<span class="gi">+	mfd-&gt;fb_imgType = MDP_BGRA_8888;</span>
 	mfd-&gt;calib_mode_bl = 0;
 
 	if (mfd-&gt;panel.type == MIPI_VIDEO_PANEL ||
<span class="gu">@@ -2143,6 +2144,25 @@ static int mdss_fb_register(struct msm_fb_data_type *mfd)</span>
 		bpp = 4;
 		break;
 
<span class="gi">+	case MDP_BGRA_8888:</span>
<span class="gi">+		fix-&gt;type = FB_TYPE_PACKED_PIXELS;</span>
<span class="gi">+		fix-&gt;xpanstep = 1;</span>
<span class="gi">+		fix-&gt;ypanstep = 1;</span>
<span class="gi">+		var-&gt;vmode = FB_VMODE_NONINTERLACED;</span>
<span class="gi">+		var-&gt;blue.offset = 0;</span>
<span class="gi">+		var-&gt;green.offset = 8;</span>
<span class="gi">+		var-&gt;red.offset = 16;</span>
<span class="gi">+		var-&gt;blue.length = 8;</span>
<span class="gi">+		var-&gt;green.length = 8;</span>
<span class="gi">+		var-&gt;red.length = 8;</span>
<span class="gi">+		var-&gt;blue.msb_right = 0;</span>
<span class="gi">+		var-&gt;green.msb_right = 0;</span>
<span class="gi">+		var-&gt;red.msb_right = 0;</span>
<span class="gi">+		var-&gt;transp.offset = 24;</span>
<span class="gi">+		var-&gt;transp.length = 8;</span>
<span class="gi">+		bpp = 4;</span>
<span class="gi">+		break;</span>
<span class="gi">+</span>
 	case MDP_YCRYCB_H2V1:
 		fix-&gt;type = FB_TYPE_INTERLEAVED_PLANES;
 		fix-&gt;xpanstep = 2;
</pre></div>
<p>Another possible workaround might be setting the default color depth to 16 bits per pixel (see <a rel="nofollow" class="external text" href="https://gitlab.com/postmarketOS/pmaports/merge_requests/132#note_133044017">this comment</a>).
</p>
<h3><span class="mw-headline" id="Exynos_devices">Exynos devices</span></h3>
<p>On newer exynos devices you typically need to edit a file in <code>drivers/video/fbdev/exynos/SOMETHING/decon_dsi.c</code>.
</p>
<p>To fix the problem where red and blue were swapped for dreamlte (exynos8895) the following patch worked:
</p>
<div class="mw-highlight mw-content-ltr" dir="ltr"><pre><span></span><span class="gh">diff --git a/drivers/video/fbdev/exynos/dpu/decon_dsi.c b/drivers/video/fbdev/exynos/dpu/decon_dsi.c</span>
<span class="gh">index eeaa2ba19778..3e597a145432 100644</span>
<span class="gd">--- a/drivers/video/fbdev/exynos/dpu/decon_dsi.c</span>
<span class="gi">+++ b/drivers/video/fbdev/exynos/dpu/decon_dsi.c</span>
<span class="gu">@@ -862,11 +862,11 @@ int decon_check_var(struct fb_var_screeninfo *var, struct fb_info *info)</span>
 	case 24:
 		/* our 24bpp is unpacked, so 32bpp */
 		var-&gt;bits_per_pixel	= 32;
<span class="gd">-		var-&gt;red.offset		= 16;</span>
<span class="gi">+		var-&gt;red.offset		= 0;</span>
 		var-&gt;red.length		= 8;
 		var-&gt;green.offset	= 8;
 		var-&gt;green.length	= 8;
<span class="gd">-		var-&gt;blue.offset	= 0;</span>
<span class="gi">+		var-&gt;blue.offset	= 16;</span>
 		var-&gt;blue.length	= 8;
 		break;
</pre></div>
<p>How this patch was found is described in the <a href="../en/Troubleshooting:display.html#Debugging_the_kernel_driver" title="Troubleshooting:display">Debugging the kernel driver</a>-section.
</p>
<h1>
<span id="Qualcomm_framebuffer_(mdss,_mdp3)"></span><span class="mw-headline" id="Qualcomm_framebuffer_.28mdss.2C_mdp3.29">Qualcomm framebuffer (mdss, mdp3)</span>
</h1>
<h2>
<span id="MSM_framebuffer_doesn't_work"></span><span class="mw-headline" id="MSM_framebuffer_doesn.27t_work">MSM framebuffer doesn't work</span>
</h2>
<p>We found out that removing the 3D driver support makes the MSM framebuffer work. See <a rel="nofollow" class="external text" href="https://github.com/postmarketOS/pmbootstrap/pull/66">#66</a>.
</p>
<pre>CONFIG_MSM_KGSL=n

-&gt; Device Drivers
    -&gt; Graphics support
        -&gt; MSM 3D Graphics driver</pre>
<p>On devices using the mdss_fb driver, adding <code>mdss-fb-init-hack</code> to the dependencies of the device package (<a rel="nofollow" class="external text" href="https://gitlab.com/postmarketOS/pmaports/-/blob/7463d922936cfbb084ebdcb97e8968ac83f1ed4a/device/testing/device-sony-amami/APKBUILD#L9">example</a>) might help.
</p>
<h2><span class="mw-headline" id="Screen_output_flicker_and_inactivity">Screen output flicker and inactivity</span></h2>
<p>If you notice a very brief flicker upon boot, but immediately disappears and screen turns black, you might have a buggy framebuffer Qualcomm MDSS MDP3 driver.
</p>
<p>You can try patching the source code by removing the function assigned to the <code>mdp3_interface-&gt;off_fnc</code> in the <code>mdp3_ctrl.c</code> file.
</p>
<p>See example patch: <a rel="nofollow" class="external autonumber" href="https://gitlab.com/postmarketOS/pmaports/-/blob/64035ac46307bd27888efc0d3af841936e9dee7b/device/testing/linux-huawei-y530/05_fix_mdp3_ctrl_off.patch">[1]</a>
</p>
<h2><span class="mw-headline" id="Screen_output_messed_up">Screen output messed up</span></h2>
<p>If the output on the screen is not aligned correctly (<a rel="nofollow" class="external text" href="https://user-images.githubusercontent.com/315080/30261765-c28df28e-96d6-11e7-971a-fd031704a810.jpg">see picture</a>) it's probably because you have a wrong value in <code>/sys/class/graphics/fb0/bits_per_pixel</code>.
</p>
<p>You can try patching the source code by setting a different video mode (RGB/ARGB/RGBA/YCRYCB/...).
</p>
<p>This may also help, when your X11 is segfaulting (see <a rel="nofollow" class="external text" href="https://github.com/postmarketOS/pmbootstrap/issues/779">#779</a>).
</p>
<p>See example patch: <a rel="nofollow" class="external text" href="https://gitlab.com/postmarketOS/pmaports/-/blob/64035ac46307bd27888efc0d3af841936e9dee7b/device/testing/linux-huawei-y530/06_fix_mdss_fb_rgb_mode.patch">06_fix_mdss_fb_rgb_mode.patch</a>
</p>
<h2><span class="mw-headline" id="Screen_is_blank_outside_of_Weston">Screen is blank outside of Weston</span></h2>
<p>Something like that should help, see <a rel="nofollow" class="external text" href="https://github.com/postmarketOS/pmbootstrap/issues/603#issuecomment-333327128">#603</a>:
</p>
<div class="mw-highlight mw-content-ltr" dir="ltr"><pre><span></span><span class="gp">$</span> <span class="nb">echo</span> <span class="m">0</span> &gt; /sys/class/graphics/fb0/blank
<span class="gp">$</span> <span class="nb">echo</span> <span class="m">1</span> &gt; /sys/devices/fd900000.qcom,mdss_mdp/qcom,mdss_fb_primary.134/leds/lcd-backlight/brightness
</pre></div>
<h1><span class="mw-headline" id="Debugging_the_kernel_driver">Debugging the kernel driver</span></h1>
<p>Generally to understand what happens in the kernel you want to print messages to dmesg with information like error codes or the value of some variable. 
</p>
<p>The quickest way to try different kernel patches is to obtain the kernel source (<code>git clone</code> or download a source tar archive), add debug messages, build the kernel with envkernel.sh and then flash it. The whole build and flash procedure is described in <a href="../en/Compiling_kernels_with_envkernel.sh.html" title="Compiling kernels with envkernel.sh">Compiling kernels with envkernel.sh</a>. Compiling and flashing only the kernel is faster than compiling and re-installing the kernel and rootfs everytime, which is done when you run <code>pmbootstrap install [--android-recovery-zip]</code>.
</p>
<p>To add debug messages you need to find interesting places where to add those though. If you have a display issue then <code>drivers/video/</code> should be where to look.
</p>
<h2><span class="mw-headline" id="Example:_error_in_Xorg.0.log">Example: error in Xorg.0.log</span></h2>
<p>In <a rel="nofollow" class="external text" href="https://gitlab.com/postmarketOS/pmbootstrap/-/issues/1618">pmbootstrap#1618</a> the screen just showed noise, and /var/log/Xorg.0.log contained lots of these errors: <code>(EE) FBDEV(0): FBIOPUTCMAP: Invalid argument</code>. It was desired to get more information about the error (what exactly is the invalid argument?). 
</p>
<p><code>grep</code>ing for FBIOPUTCMAP in the kernel source showed that the error comes from drivers/video/fbmem.c, and so some suitable debug messages could be:
</p>
<div class="mw-highlight mw-content-ltr" dir="ltr"><pre><span></span><span class="gh">diff --git a/drivers/video/fbmem.c b/drivers/video/fbmem.c</span>
<span class="gh">index 3e6371dc9038..a3ccb86baec6 100755</span>
<span class="gd">--- a/drivers/video/fbmem.c</span>
<span class="gi">+++ b/drivers/video/fbmem.c</span>
<span class="gu">@@ -1096,9 +1096,15 @@ static long do_fb_ioctl(struct fb_info *info, unsigned int cmd,</span>
 		ret = copy_to_user(argp, &amp;fix, sizeof(fix)) ? -EFAULT : 0;
 		break;
 	case FBIOPUTCMAP:
<span class="gd">-		if (copy_from_user(&amp;cmap, argp, sizeof(cmap)))</span>
<span class="gi">+			printk(KERN_ERR "PMOS DEBUG: calling copy_from_user...\n");</span>
<span class="gi">+		if (copy_from_user(&amp;cmap, argp, sizeof(cmap))) {</span>
<span class="gi">+			printk(KERN_ERR "PMOS DEBUG: copy_from_user failed!\n");</span>
 			return -EFAULT;
<span class="gi">+		}</span>
<span class="gi">+		printk(KERN_ERR "PMOS DEBUG: copy_from_user ok!\n");</span>
<span class="gi">+		printk(KERN_ERR "PMOS DEBUG: calling fb_set_user_cmap...\n");</span>
 		ret = fb_set_user_cmap(&amp;cmap, info);
<span class="gi">+		printk(KERN_ERR "PMOS DEBUG: fb_set_user_cmap returned %d\n", ret);</span>
 		break;
 	case FBIOGETCMAP:
 		if (copy_from_user(&amp;cmap, argp, sizeof(cmap)))
</pre></div>
<h2><span class="mw-headline" id="Example:_red_and_blue_colors_are_swapped">Example: red and blue colors are swapped</span></h2>
<p>In <a rel="nofollow" class="external text" href="https://gitlab.com/postmarketOS/pmaports/-/issues/916">pmaports#916</a> red and blue were switched on the display. As described in <a href="../en/Troubleshooting:display.html#Colors_are_wrong_in_some_way" title="Troubleshooting:display">Colors are wrong in some way</a> this most likely meant that that the framebuffer mode had to be changed somewhere. <code>grep</code>ing for <code>BGRA</code>, <code>RGBA</code> and <code>red\.offset</code> in drivers/video/ showed quite a lot of places to investigate. Since this was on an exynos device files in <code>drivers/video/fbdev/exynos</code> seemed especially interesting.
</p>
<p>Since for many Qualcomm devices it was possible to simply change the mode from BGRA to RGBA or vice-versa, the first thing tried was this patch:
</p>
<div class="mw-highlight mw-content-ltr" dir="ltr"><pre><span></span><span class="gh">diff --git a/drivers/video/fbdev/exynos/decon_8890/decon_core.c b/drivers/video/fbdev/exynos/decon_8890/decon_core.c</span>
<span class="gh">index 2b65c68d8c74..388e94077847 100644</span>
<span class="gd">--- a/drivers/video/fbdev/exynos/decon_8890/decon_core.c</span>
<span class="gi">+++ b/drivers/video/fbdev/exynos/decon_8890/decon_core.c</span>
<span class="gu">@@ -3924,7 +3924,8 @@ static int decon_probe(struct platform_device *pdev)</span>
                decon-&gt;vpp_used[decon-&gt;default_idma] = true;
                memset(&amp;config, 0, sizeof(struct decon_win_config));
                config.vpp_parm.addr[0] = fbinfo-&gt;fix.smem_start;
<span class="gd">-               config.format = DECON_PIXEL_FORMAT_RGBA_8888;</span>
<span class="gi">+               pr_err("PMOS DEBUG: decon_8890/decon_core: setting format to BGRA\n");</span>
<span class="gi">+               config.format = DECON_PIXEL_FORMAT_BGRA_8888;</span>
                config.src.w = fbinfo-&gt;var.xres;
                config.src.h = fbinfo-&gt;var.yres;
                config.src.f_w = fbinfo-&gt;var.xres;
<span class="gh">diff --git a/drivers/video/fbdev/exynos/dpu/decon_core.c b/drivers/video/fbdev/exynos/dpu/decon_core.c</span>
<span class="gh">index 152c86e06d74..662c0dc1a74f 100644</span>
<span class="gd">--- a/drivers/video/fbdev/exynos/dpu/decon_core.c</span>
<span class="gi">+++ b/drivers/video/fbdev/exynos/dpu/decon_core.c</span>
<span class="gu">@@ -4076,7 +4076,8 @@ static int decon_initial_display(struct decon_device *decon, bool is_colormap)</span>
        set_bit(decon-&gt;dt.dft_idma, &amp;decon-&gt;prev_used_dpp);
        memset(&amp;config, 0, sizeof(struct decon_win_config));
        config.dpp_parm.addr[0] = fbinfo-&gt;fix.smem_start;
<span class="gd">-       config.format = DECON_PIXEL_FORMAT_BGRA_8888;</span>
<span class="gi">+       pr_err("PMOS DEBUG: decon_8890/decon_dsi: setting format to RGBA\n");</span>
<span class="gi">+       config.format = DECON_PIXEL_FORMAT_RGBA_8888;</span>
        config.src.w = fbinfo-&gt;var.xres;
        config.src.h = fbinfo-&gt;var.yres;
        config.src.f_w = fbinfo-&gt;var.xres;
<span class="gh">diff --git a/drivers/video/fbdev/exynos/dual_dpu/decon_core.c b/drivers/video/fbdev/exynos/dual_dpu/decon_core.c</span>
<span class="gh">index d02af9c7e30a..1b9aa3ee57b1 100644</span>
<span class="gd">--- a/drivers/video/fbdev/exynos/dual_dpu/decon_core.c</span>
<span class="gi">+++ b/drivers/video/fbdev/exynos/dual_dpu/decon_core.c</span>
<span class="gu">@@ -3735,7 +3735,8 @@ static int decon_initial_display(struct decon_device *decon, bool is_colormap)</span>
        set_bit(decon-&gt;dt.dft_idma, &amp;decon-&gt;prev_used_dpp);
        memset(&amp;config, 0, sizeof(struct decon_win_config));
        config.dpp_parm.addr[0] = fbinfo-&gt;fix.smem_start;
<span class="gd">-       config.format = DECON_PIXEL_FORMAT_BGRA_8888;</span>
<span class="gi">+       pr_err("PMOS DEBUG: dual_dpu/decon_core: setting format to RGBA\n");</span>
<span class="gi">+       config.format = DECON_PIXEL_FORMAT_RGBA_8888;</span>
        config.src.w = fbinfo-&gt;var.xres;
        config.src.h = fbinfo-&gt;var.yres;
        config.src.f_w = fbinfo-&gt;var.xres;
</pre></div>
<p>After compiling, flashing and booting the kernel, the colors were still wrong, and none of the messages showed up in dmesg, so this not the right places to set the mode. Next focus was therefore on the grep results of <code>red\.offset</code> in <code>drivers/video/fbdev/exynos/</code>. <code>red.offset</code> was being set in <code>drivers/video/fbdev/exynos/decon_8890/decon_dsi.c</code>, <code>drivers/video/fbdev/exynos/dpu/decon_dsi.c</code> and <code>drivers/video/fbdev/exynos/dual_dpu/decon_dsi.c</code> so this patch was added:
</p>
<div class="mw-highlight mw-content-ltr" dir="ltr"><pre><span></span><span class="gh">diff --git a/drivers/video/fbdev/exynos/decon_8890/decon_dsi.c b/drivers/video/fbdev/exynos/decon_8890/decon_dsi.c</span>
<span class="gh">index 8703b56108ac..101d1460ee98 100644</span>
<span class="gd">--- a/drivers/video/fbdev/exynos/decon_8890/decon_dsi.c</span>
<span class="gi">+++ b/drivers/video/fbdev/exynos/decon_8890/decon_dsi.c</span>
<span class="gu">@@ -187,6 +187,8 @@ int decon_check_var(struct fb_var_screeninfo *var, struct fb_info *info)</span>
        var-&gt;transp.offset = 0;
        var-&gt;transp.length = 0;
 
<span class="gi">+       pr_err("PMOS_DEBUG: decon_8890/decon_dsi: bits_per_pixel %d\n", var-&gt;bits_per_pixel);</span>
<span class="gi">+</span>
        switch (var-&gt;bits_per_pixel) {
        case 1:
        case 2:
<span class="gh">diff --git a/drivers/video/fbdev/exynos/dpu/decon_dsi.c b/drivers/video/fbdev/exynos/dpu/decon_dsi.c</span>
<span class="gh">index eeaa2ba19778..70a645fd8f4b 100644</span>
<span class="gd">--- a/drivers/video/fbdev/exynos/dpu/decon_dsi.c</span>
<span class="gi">+++ b/drivers/video/fbdev/exynos/dpu/decon_dsi.c</span>
<span class="gu">@@ -812,6 +812,8 @@ int decon_check_var(struct fb_var_screeninfo *var, struct fb_info *info)</span>
        var-&gt;transp.offset = 0;
        var-&gt;transp.length = 0;
 
<span class="gi">+       pr_err("PMOS_DEBUG: dpu/decon_dsi: bits_per_pixel %d\n", var-&gt;bits_per_pixel);</span>
<span class="gi">+</span>
        switch (var-&gt;bits_per_pixel) {
        case 1:
        case 2:
<span class="gh">diff --git a/drivers/video/fbdev/exynos/dual_dpu/decon_dsi.c b/drivers/video/fbdev/exynos/dual_dpu/decon_dsi.c</span>
<span class="gh">index d01b913bc8e0..30d7391b1bfa 100644</span>
<span class="gd">--- a/drivers/video/fbdev/exynos/dual_dpu/decon_dsi.c</span>
<span class="gi">+++ b/drivers/video/fbdev/exynos/dual_dpu/decon_dsi.c</span>
<span class="gu">@@ -815,6 +815,8 @@ int decon_check_var(struct fb_var_screeninfo *var, struct fb_info *info)</span>
        var-&gt;transp.offset = 0;
        var-&gt;transp.length = 0;
 
<span class="gi">+       pr_err("PMOS_DEBUG: dual_dpu/decon_dsi: bits_per_pixel %d\n", var-&gt;bits_per_pixel);</span>
<span class="gi">+</span>
        switch (var-&gt;bits_per_pixel) {
        case 1:
        case 2:
</pre></div>
<p>After compiling, flashing and booting the kernel only the message from <code>dpu/decon_dsi.c</code> appeared in dmesg, and bits_per_pixel was 32.
</p>
<p>In the same file we have
</p>
<div class="mw-highlight mw-content-ltr" dir="ltr"><pre><span></span>	<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>

    <span class="p">[...]</span>

	<span class="k">case</span> <span class="mi">32</span><span class="o">:</span>
	<span class="k">case</span> <span class="mi">28</span><span class="o">:</span>
	<span class="k">case</span> <span class="mi">25</span><span class="o">:</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span>	<span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">-</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="cm">/* drop through */</span>
	<span class="k">case</span> <span class="mi">24</span><span class="o">:</span>
		<span class="cm">/* our 24bpp is unpacked, so 32bpp */</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span>	<span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span>		<span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
</pre></div>
<p>Each pixel is 32 bit, and they are unpacked in the order BGRA, since blue.offset=0, green.offset=8, red.offset=16 and transp.offset=24. Since we want to swap blue&lt;-&gt;red we change those offsets:
</p>
<div class="mw-highlight mw-content-ltr" dir="ltr"><pre><span></span><span class="gh">diff --git a/drivers/video/fbdev/exynos/dpu/decon_dsi.c b/drivers/video/fbdev/exynos/dpu/decon_dsi.c</span>
<span class="gh">index eeaa2ba19778..3e597a145432 100644</span>
<span class="gd">--- a/drivers/video/fbdev/exynos/dpu/decon_dsi.c</span>
<span class="gi">+++ b/drivers/video/fbdev/exynos/dpu/decon_dsi.c</span>
<span class="gu">@@ -862,11 +862,11 @@ int decon_check_var(struct fb_var_screeninfo *var, struct fb_info *info)</span>
 	case 24:
 		/* our 24bpp is unpacked, so 32bpp */
 		var-&gt;bits_per_pixel	= 32;
<span class="gd">-		var-&gt;red.offset		= 16;</span>
<span class="gi">+		var-&gt;red.offset		= 0;</span>
 		var-&gt;red.length		= 8;
 		var-&gt;green.offset	= 8;
 		var-&gt;green.length	= 8;
<span class="gd">-		var-&gt;blue.offset	= 0;</span>
<span class="gi">+		var-&gt;blue.offset	= 16;</span>
 		var-&gt;blue.length	= 8;
 		break;
</pre></div>
<p>And after compiling, flashing and booting the kernel the problem is solved!
</p>
<h1><span class="mw-headline" id="See_also">See also</span></h1>
<ul>
<li>
<a rel="nofollow" class="external text" href="https://gitlab.com/postmarketOS/pmaports/-/issues/211">pmaports#211</a>: framebuffer: red and blue are swapped on devices using MSM8974</li>
<li>
<a rel="nofollow" class="external text" href="https://gitlab.com/postmarketOS/pmaports/-/issues/297">pmaports#297</a>: alternative patch to fix refresh rate for kernel 3.4.113 android_kernel_oppo_msm8974 and similar</li>
<li>
<a rel="nofollow" class="external text" href="https://gitlab.com/postmarketOS/pmaports/-/issues/916">pmaports#916</a>: red and blue are swapped on dreamlte (exynos8895)</li>
<li><a rel="nofollow" class="external text" href="https://www.kernel.org/doc/html/latest/fb/api.html">Kernel documentation on the framebuffer api</a></li>
<li><a rel="nofollow" class="external text" href="https://wiki.postmarketos.org/wiki/HTC_One_XL_(htc-evita)#Other">Red screen issue on HTC-One XL</a></li>
</ul>
</div></div>
		
		<div id="catlinks" class="catlinks" data-mw="interface"><div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../en/Category:Troubleshooting.html" title="Category:Troubleshooting">Troubleshooting</a></li></ul>
</div></div>
		<div class="visualClear"></div>
		
	</div>
</div>


		<div id="footer" role="contentinfo" style="margin: 0">
						<ul id="footer-info">
								<li>Retrieved from "<a dir="ltr" href="https://wiki.postmarketos.org/index.php?title=Troubleshooting:display&amp;oldid=45287">https://wiki.postmarketos.org/index.php?title=Troubleshooting:display&amp;oldid=45287</a>"</li>
		
		<li id="footer-info-lastmod"> This page was last edited on 20 June 2023, at 20:51.</li>
								<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike</a> unless otherwise noted.</li>
							<br>
</ul>
						<ul id="footer-places">
								<li id="footer-places-privacy"><a href="../en/PostmarketOS:Privacy_policy.html" title="PostmarketOS:Privacy policy">Privacy policy</a></li>
								<li id="footer-places-about"><a href="../en/About_postmarketOS.html" class="mw-redirect" title="PostmarketOS:About">About postmarketOS</a></li>
								<li id="footer-places-disclaimer"><a href="../en/PostmarketOS:General_disclaimer.html" title="PostmarketOS:General disclaimer">Disclaimers</a></li>
								<li id="footer-places-mobileview"><a href="https://wiki.postmarketos.org/index.php?title=Troubleshooting:display&amp;mobileaction=toggle_view_mobile" class="noprint stopMobileRedirectToggle">Mobile view</a></li>
							</ul>
										<ul id="footer-icons" class="noprint">
										<li id="footer-copyrightico">
						<a href="https://creativecommons.org/licenses/by-sa/4.0/"><img src="../cc-by-sa.png" alt="Creative Commons Attribution-ShareAlike" width="88" height="31"></a>					</li>
										<li id="footer-poweredbyico">
						<a href="https://www.mediawiki.org/"><img src="../poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" srcset="" width="88" height="31"></a>					</li>
									</ul>
						<div style="clear: both;"></div>
		</div>
		

</body>
</html>
