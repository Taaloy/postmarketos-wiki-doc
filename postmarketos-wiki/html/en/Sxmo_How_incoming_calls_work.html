<!DOCTYPE html>
<html class="client-nojs" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<title>Sxmo/How incoming calls work - postmarketOS</title>
<link rel="stylesheet" href="../PostmarketOSWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<meta name="generator" content="MediaWiki 1.39.6">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=0.25, maximum-scale=5.0">
<link rel="icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="postmarketOS (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.postmarketos.org/api.php?action=rsd">
<link rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">
<link rel="alternate" type="application/atom+xml" title="postmarketOS Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="skin-vector skin-vector-search-vue mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Sxmo_How_incoming_calls_work rootpage-Sxmo_How_incoming_calls_work skin-vector-2022 action-view skin--responsive vector-feature-language-in-header-enabled vector-feature-language-in-main-page-header-disabled vector-feature-language-alert-in-sidebar-disabled vector-feature-sticky-header-disabled vector-feature-sticky-header-edit-disabled vector-feature-table-of-contents-disabled vector-feature-visual-enhancement-next-disabled">
<div class="mw-page-container">
	<span id="top-page"></span>
	<a class="mw-jump-link" href="#content">Jump to content</a>
	<div class="mw-page-container-inner">
		<input type="checkbox" id="mw-sidebar-checkbox" class="mw-checkbox-hack-checkbox">
		<header class="mw-header">
			<div class="mw-header-aside">
			<label id="mw-sidebar-button" class="mw-checkbox-hack-button mw-ui-icon mw-ui-button mw-ui-quiet mw-ui-icon-element" for="mw-sidebar-checkbox" role="button" aria-controls="mw-panel" data-event-name="ui.sidebar" tabindex="0" title="Main menu">
				<span>Toggle sidebar</span>
			</label>
			
<a href="../en/Main_Page.html" class="mw-logo">
	<img class="mw-logo-icon" src="/logo_50x50.svg" alt="" aria-hidden="true" height="50" width="50">
	<span class="mw-logo-container">
		<strong class="mw-logo-wordmark">postmarketOS</strong>
	</span>
</a>

			</div>
			<div class="mw-header-content">
			
<div id="p-search" role="search" class="vector-search-box-vue  vector-search-box-collapses  vector-search-box-show-thumbnail vector-search-box-auto-expand-width vector-search-box">
	<a href="../Special:Search.html" title="Search postmarketOS [f]" accesskey="f" class="mw-ui-button mw-ui-quiet mw-ui-icon mw-ui-icon-element mw-ui-icon-wikimedia-search search-toggle">
		<span>Search</span>
	</a>
	
	<div>
		<form action="/index.php" id="searchform" class="vector-search-box-form">
			<div id="simpleSearch" class="vector-search-box-inner" data-search-loc="header-moved">
				<input class="vector-search-box-input" type="search" name="search" placeholder="Search postmarketOS" aria-label="Search postmarketOS" autocapitalize="sentences" title="Search postmarketOS [f]" accesskey="f" id="searchInput">
				<input type="hidden" name="title" value="Special:Search">
				<input id="mw-searchButton" class="searchButton mw-fallbackSearchButton" type="submit" name="fulltext" title="Search the pages for this text" value="Search">
				<input id="searchButton" class="searchButton" type="submit" name="go" title="Go to a page with this exact name if it exists" value="Go">
			</div>
		</form>
	</div>
</div>

			<nav class="vector-user-links" aria-label="Personal tools" role="navigation">
	

<div id="p-vector-user-menu-overflow" class="vector-menu mw-portlet mw-portlet-vector-user-menu-overflow vector-user-menu-overflow">
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"><li id="pt-createaccount-2" class="user-links-collapsible-item mw-list-item"><a href="../Special:RequestAccount.html"><span>Request account</span></a></li></ul>
		
	</div>
</div>

	

<div id="p-personal" class="vector-menu mw-portlet mw-portlet-personal vector-user-menu vector-user-menu-logged-out vector-menu-dropdown" title="More options">
	<input type="checkbox" id="p-personal-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-p-personal" class="vector-menu-checkbox">
	<label id="p-personal-label" for="p-personal-checkbox" class="vector-menu-heading mw-ui-button mw-ui-quiet mw-ui-icon mw-ui-icon-element mw-ui-icon-ellipsis mw-ui-icon-wikimedia-ellipsis">
		<span class="vector-menu-heading-label">Personal tools</span>
	</label>
	<div class="vector-menu-content">
		<div class="vector-user-menu-create-account"><a href="/index.php?title=Special:CreateAccount&amp;returnto=Sxmo%2FHow+incoming+calls+work" class="vector-menu-content-item user-links-collapsible-item" title="You are encouraged to create an account and log in; however, it is not mandatory"><span class="mw-ui-icon mw-ui-icon-userAdd mw-ui-icon-wikimedia-userAdd"></span> <span>Create account</span></a></div>
<div class="vector-user-menu-login"><a href="/index.php?title=Special:UserLogin&amp;returnto=Sxmo%2FHow+incoming+calls+work" class="vector-menu-content-item vector-menu-content-item-login" title="You are encouraged to log in; however, it is not mandatory [o]" accesskey="o"><span class="mw-ui-icon mw-ui-icon-logIn mw-ui-icon-wikimedia-logIn"></span> <span>Log in</span></a></div>

		<ul class="vector-menu-content-list"></ul>
		
	</div>
</div>

</nav>

			</div>
		</header>
		<div class="vector-sidebar-container ">
			</div>
		<div class="vector-sitenotice-container">
			<div id="siteNotice"></div>
		</div>
		<input type="checkbox" id="vector-toc-collapsed-checkbox" class="mw-checkbox-hack-checkbox">
		<div class="mw-table-of-contents-container">
			<div class="vector-sticky-toc-container mw-sticky-header-element">
				<nav id="mw-panel-toc" class="sidebar-toc" role="navigation" aria-labelledby="sidebar-toc-label" data-event-name="ui.sidebar-toc">
	<div id="sidebar-toc-label" class="sidebar-toc-header">
		<p class="sidebar-toc-title">
		Contents
		<button class="vector-toc-uncollapse-button">move to sidebar</button>
		<button class="vector-toc-collapse-button">hide</button>
		</p>
	</div>
	<ul class="sidebar-toc-contents" id="mw-panel-toc-list">
		<li id="toc-mw-content-text" class="sidebar-toc-list-item sidebar-toc-level-1">
			<a href="#top-page" class="sidebar-toc-link">
				<div class="sidebar-toc-text">Beginning</div>
			</a>
		</li>
		<li id="toc-Introduction" class="sidebar-toc-list-item sidebar-toc-level-1 sidebar-toc-list-item-expanded">
			<a class="sidebar-toc-link" href="#Introduction">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">1</span>Introduction</div>
			</a>
			
			<ul id="toc-Introduction-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-Monitoring_for_incoming_calls" class="sidebar-toc-list-item sidebar-toc-level-1 sidebar-toc-list-item-expanded">
			<a class="sidebar-toc-link" href="#Monitoring_for_incoming_calls">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">2</span>Monitoring for incoming calls</div>
			</a>
			
			<ul id="toc-Monitoring_for_incoming_calls-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-Picking_up_the_call" class="sidebar-toc-list-item sidebar-toc-level-1 sidebar-toc-list-item-expanded">
			<a class="sidebar-toc-link" href="#Picking_up_the_call">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">3</span>Picking up the call</div>
			</a>
			
			<ul id="toc-Picking_up_the_call-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-Setting_up_the_audio_pipeline_for_calls" class="sidebar-toc-list-item sidebar-toc-level-1 sidebar-toc-list-item-expanded">
			<a class="sidebar-toc-link" href="#Setting_up_the_audio_pipeline_for_calls">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">4</span>Setting up the audio pipeline for calls</div>
			</a>
			
			<ul id="toc-Setting_up_the_audio_pipeline_for_calls-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-Picking_up_the_call_2" class="sidebar-toc-list-item sidebar-toc-level-1 sidebar-toc-list-item-expanded">
			<a class="sidebar-toc-link" href="#Picking_up_the_call_2">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">5</span>Picking up the call</div>
			</a>
			
			<ul id="toc-Picking_up_the_call_2-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-Ending_the_call" class="sidebar-toc-list-item sidebar-toc-level-1 sidebar-toc-list-item-expanded">
			<a class="sidebar-toc-link" href="#Ending_the_call">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">6</span>Ending the call</div>
			</a>
			
			<ul id="toc-Ending_the_call-sublist" class="sidebar-toc-list">
			</ul>
		</li>
		<li id="toc-Resetting_audio_pipeline" class="sidebar-toc-list-item sidebar-toc-level-1 sidebar-toc-list-item-expanded">
			<a class="sidebar-toc-link" href="#Resetting_audio_pipeline">
				<div class="sidebar-toc-text">
				<span class="sidebar-toc-numb">7</span>Resetting audio pipeline</div>
			</a>
			
			<ul id="toc-Resetting_audio_pipeline-sublist" class="sidebar-toc-list">
			</ul>
		</li>
	</ul>
</nav>

			</div>
		</div>
		<div class="mw-content-container">
			<main id="content" class="mw-body" role="main" style="margin: 0">
				<a id="top"></a>
				<header class="mw-body-header">
				
				
					<label id="vector-toc-collapsed-button" class="mw-ui-button mw-ui-quiet mw-ui-icon mw-ui-icon-element mw-ui-icon-wikimedia-listBullet mw-checkbox-hack-button" for="vector-toc-collapsed-checkbox" role="button" aria-controls="toc-toggle-list" data-event-name="vector.toc-toggle-list" tabindex="0" title="Table of Contents">
						Toggle the table of contents
					</label>
				    <h1 id="firstHeading" class="firstHeading mw-first-heading"><span class="mw-page-title-main">Sxmo/How incoming calls work</span></h1>
				</header>
				<nav class="vector-article-toolbar" aria-label="Tools" role="navigation">
					<div class="mw-article-toolbar-container">
						<div id="left-navigation">
							

<div id="p-associated-pages" class="vector-menu mw-portlet mw-portlet-associated-pages vector-menu-tabs">
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list">
<li id="ca-nstab-main" class="selected mw-list-item"><a href="../en/Sxmo_How_incoming_calls_work.html" title="View the content page [c]" accesskey="c"><span>Page</span></a></li>
<li id="ca-talk" class="new mw-list-item"><a href="/index.php?title=Talk:Sxmo/How_incoming_calls_work&amp;action=edit&amp;redlink=1" rel="discussion" title="Discussion about the content page (page does not exist) [t]" accesskey="t"><span>Discussion</span></a></li>
</ul>
		
	</div>
</div>

							

<div id="p-variants" class="vector-menu mw-portlet mw-portlet-variants emptyPortlet vector-menu-dropdown">
	<input type="checkbox" id="p-variants-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-p-variants" class="vector-menu-checkbox" aria-label="Change language variant">
	<label id="p-variants-label" for="p-variants-checkbox" class="vector-menu-heading ">
		<span class="vector-menu-heading-label">English</span>
	</label>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list"></ul>
		
	</div>
</div>

						</div>
						<div id="right-navigation" class="vector-collapsible ">
							

<div id="p-views" class="vector-menu mw-portlet mw-portlet-views vector-menu-tabs">
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list">
<li id="ca-view" class="selected mw-list-item"><a href="../en/Sxmo_How_incoming_calls_work.html"><span>Read</span></a></li>
<li id="ca-viewsource" class="mw-list-item"><a href="/index.php?title=Sxmo/How_incoming_calls_work&amp;action=edit" title="This page is protected.
You can view its source [e]" accesskey="e"><span>View source</span></a></li>
<li id="ca-history" class="mw-list-item"><a href="/index.php?title=Sxmo/How_incoming_calls_work&amp;action=history" title="Past revisions of this page [h]" accesskey="h"><span>View history</span></a></li>
</ul>
		
	</div>
</div>

							

<div id="p-cactions" class="vector-menu mw-portlet mw-portlet-cactions emptyPortlet vector-menu-dropdown vector-has-collapsible-items" title="More options">
	<input type="checkbox" id="p-cactions-checkbox" role="button" aria-haspopup="true" data-event-name="ui.dropdown-p-cactions" class="vector-menu-checkbox">
	<label id="p-cactions-label" for="p-cactions-checkbox" class="vector-menu-heading ">
		<span class="vector-menu-heading-label">More</span>
	</label>
	<div class="vector-menu-content">
		
		<ul class="vector-menu-content-list">
<li id="ca-more-view" class="selected vector-more-collapsible-item mw-list-item"><a href="../en/Sxmo_How_incoming_calls_work.html"><span>Read</span></a></li>
<li id="ca-more-viewsource" class="vector-more-collapsible-item mw-list-item"><a href="/index.php?title=Sxmo/How_incoming_calls_work&amp;action=edit"><span>View source</span></a></li>
<li id="ca-more-history" class="vector-more-collapsible-item mw-list-item"><a href="/index.php?title=Sxmo/How_incoming_calls_work&amp;action=history"><span>View history</span></a></li>
</ul>
		
	</div>
</div>

						</div>
					</div>
				</nav>
				<div id="bodyContent" class="vector-body" data-mw-ve-target-container>
					<div class="mw-body-subheader">
					        <div class="mw-indicators">
        </div>

					    <div id="siteSub" class="noprint">From postmarketOS</div>
					</div>
					
					
					
					<div id="mw-content-text" class="mw-body-content mw-content-ltr" lang="en" dir="ltr">
<div class="mw-parser-output">
<tocplace></tocplace>
<h2><span class="mw-headline" id="Introduction">Introduction</span></h2>
<p>Caution: This write-up is based on SXMO 0.15.1. If you are running a different version, things might work in a completely different way.
</p>
<p>Since SXMO is mostly shell scripts, it's quite easy to follow, if you are familiar with reading and writing those.
SXMO uses (customizable) <a rel="nofollow" class="external text" href="https://man.sr.ht/~anjan/sxmo-docs/USERGUIDE.md#stronghooksstrong">hooks</a> for all kinds of things, like start-up, log-out, picking up, or hanging up calls.
When the graphical user interface starts it (by default) runs <code>/usr/share/sxmo/default_hooks/sxmo_hook_start.sh</code>.
This is done either via <code>~/.config/sxmo/sway</code> (wayland) or <code>~/.config/sxmo/xinit</code> (X11).
</p>
<h2><span class="mw-headline" id="Monitoring_for_incoming_calls">Monitoring for incoming calls</span></h2>
<p>The start hook mentioned in the introduction starts a user service (via superd) called <code>sxmo_modemmonitor</code> which then runs the script <code>/usr/bin/sxmo_modemmonitor.sh</code>.
The script starts a bunch of infinite loop in the background.
One of the loops is watching the DBUS for messages from ModemManager for incoming calls.
If it gets an appropriate trigger (a line that starts with "signal") it starts yet another script (<code>/usr/bin/sxmo_modem.sh</code>) to check for incoming calls.
These four lines of code are basically the magic the SXMO specific magic that make all of it work:
</p>
<pre># Monitor for incoming calls
dbus-monitor --system "interface='org.freedesktop.ModemManager1.Modem.Voice',type='signal',member='CallAdded'" |
        while read -r line; do
                echo "$line" | grep -qE "^signal" &amp;&amp; sxmo_modem.sh checkforincomingcalls
        done &amp;
</pre>
<p>The <code>checkforincomingcalls</code> function in <code>sxmo_modem.sh</code> then extracts the caller ID and forwards it to <code>/usr/bin/sxmo_modemcall.sh</code>.
(<code>checkforincomingcalls</code> actually does quite a bit more but that is not in the scope of this write-up.)
</p>
<h2><span class="mw-headline" id="Picking_up_the_call">Picking up the call</span></h2>
<p>Now we finally come to the part where the user can pick up the call. <code>sxmo_modemcall.sh</code> shows a menu that lets the user decide if they want to pick up, hang up, or ignore the call.
In this write-up we're only interested in the part where the user picks up.
When picking up the call the first thing that happens is that <code>/usr/bin/sxmo_modemaudio.sh</code> sets up the audio pipeline for calls before accepting the call.
</p>
<h2><span class="mw-headline" id="Setting_up_the_audio_pipeline_for_calls">Setting up the audio pipeline for calls</span></h2>
<p>Voice calls via the modem work differently then, e.g. recording and playing back "normal" audio.
The tool <code>callaudio</code> performs the heavy lifting for us.
<code>sxmo_modemaudio.sh</code> just sends a message via DBUS to tell it to enable the setup for voice calls.
It then calls the hook <code>sxmo_hook_call_audio.sh</code> with the parameter <code>"enable"</code>.
This hook then calls <code>sxmo_modemaudio.sh</code> again to
</p>
<ol>
<li>enable the speaker</li>
<li>disable the speaker</li>
<li>mute the mic</li>
<li>unmute the mic</li>
</ol>
<p>By doing so, it avoids situations, where either the speaker is enabled or the mic is muted at the beginning of a call.
</p>
<h2><span class="mw-headline" id="Picking_up_the_call_2">Picking up the call</span></h2>
<p>After the audio pipeline is setup for calls, it is finally time for <code>sxmo_modemcall.sh</code> to pick up by accepting the call through <code>mmcli</code>.
Then <code>sxmo_modemcall.sh</code> shows a menu that lets the user interact with the call (change audio settings, send DTMF tones, hang up...).
</p>
<h2><span class="mw-headline" id="Ending_the_call">Ending the call</span></h2>
<p>There are two situations how a call ends. Either the user on our end decides to hang up or the other party hangs up.
If the user selects the hang up option in the in-call menu, <code>sxmo_modecall.sh</code> ends the call by hanging up through <code>mmcli</code>.
In either situation (user or other party hangs up) the clean up procedure is started from <code>sxmo_modemmonitor.sh</code>.
It not only watches the DBUS for messages from ModemManager for incoming calls (see above) but also for finished calls.
If it gets an appropriate trigger (a line that starts with "signal") it starts <code>/usr/bin/sxmo_modem.sh</code> to check for finished calls.
</p>
<pre># Monitor for finished calls
dbus-monitor --system "interface='org.freedesktop.DBus.Properties',member='PropertiesChanged',arg0='org.freedesktop.ModemManager1.Call'" |
        while read -r line; do
                echo "$line" | grep -qE "^signal" &amp;&amp; sxmo_modem.sh checkforfinishedcalls
        done &amp;
</pre>
<p>The <code>checkforfinishedcalls</code> function in <code>sxmo_modem.sh</code> then deletes the call via <code>mmcli</code>, closes the in-call menu, and calls <code>sxmo_modemaudio.sh</code> to <code>reset_audio</code>.
</p>
<h2><span class="mw-headline" id="Resetting_audio_pipeline">Resetting audio pipeline</span></h2>
<p>The order is in reverse to the setup.
First the <code>reset_audio</code> method in <code>sxmo_modemaudio.sh</code> calls the hook <code>sxmo_hook_call_audio.sh</code> with the parameter <code>"disable"</code>.
This hook then calls <code>sxmo_modemaudio.sh</code> again to
</p>
<ol>
<li>disable the speaker</li>
<li>enable the speaker</li>
</ol>
<p>By doing so, the hook avoids situations, where the speaker remains disabled after a call.
Finally, the <code>reset_audio</code> method in <code>sxmo_modemaudio.sh</code> sends a message via DBUS to tell <code>callaudio</code> to disable the setup for voice calls.
</p>
</div>
</div>
					<div id="catlinks" class="catlinks catlinks-allhidden" data-mw="interface"></div>
				</div>
			</main>
			
		</div>
		<div class="mw-footer-container">
			
<footer id="footer" class="mw-footer" role="contentinfo" style="margin: 0">
	<ul id="footer-info">
	<li data-nosnippet="">Retrieved from "<a dir="ltr" href="https://wiki.postmarketos.org/index.php?title=Sxmo/How_incoming_calls_work&amp;oldid=54106">https://wiki.postmarketos.org/index.php?title=Sxmo/How_incoming_calls_work&amp;oldid=54106</a>"</li>
<li id="footer-info-lastmod"> This page was last edited on 23 December 2023, at 12:03.</li>
	<li id="footer-info-copyright">Content is available under <a class="external" rel="nofollow" href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike</a> unless otherwise noted.</li>
<br>
</ul>

	<ul id="footer-places">
	<li id="footer-places-privacy"><a href="../en/PostmarketOS:Privacy_policy.html">Privacy policy</a></li>
	<li id="footer-places-about"><a href="../en/About_postmarketOS.html">About postmarketOS</a></li>
	<li id="footer-places-disclaimer"><a href="../en/PostmarketOS:General_disclaimer.html">Disclaimers</a></li>
</ul>

	<ul id="footer-icons" class="noprint">
	<li id="footer-copyrightico"><a href="https://creativecommons.org/licenses/by-sa/4.0/"><img src="../cc-by-sa.png" alt="Creative Commons Attribution-ShareAlike" width="88" height="31" loading="lazy"></a></li>
	<li id="footer-poweredbyico"><a href="https://www.mediawiki.org/"><img src="../poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" srcset="" width="88" height="31" loading="lazy"></a></li>
</ul>

</footer>

		</div>
	</div> 
</div> 

</body>
</html>
